<!DOCTYPE html>
<head th:replace="~{layout/include::link}" xmlns:v-on="http://www.w3.org/1999/xhtml"/>
<body>

<div th:replace="~{layout/header::header-title(|${member.name}|)}"></div>

<div class="body">
  <div th:if="${member.department}" class="calendar" th:attr="data-member_id=${member.id}">
    <div class="month-control row">
      <h1>
        <a class="move h_pointer" v-on:click="addMonth(-1)">
          <i class="bi bi-arrow-left-circle"></i>
        </a>
        <input type="month" v-model="combinedYearMonth">
        <a class="move h_pointer" v-on:click="addMonth(1)">
          <i class="bi bi-arrow-right-circle"></i>
        </a>
      </h1>
    </div>
    <div class="dutyTypes">
    <span v-for="type in department.dutyTypes">
      <span :class="['indicator', 'BACKGROUND-' + type.color]">&nbsp;&nbsp;&nbsp;</span>
      <span v-text="type.name"></span>
    </span>
      <button th:if="${#strings.equals(member.id, loginMember?.id) || member.managerId==loginMember?.id}"
              class="edit-btn"
              v-on:click="editDuty"
      >
        수정<i class="bi bi-pencil-square"></i>
      </button>
    </div>
    <ul class="weekdays">
      <li><abbr title="S">SUN</abbr></li>
      <li><abbr title="M">MON</abbr></li>
      <li><abbr title="T">TUE</abbr></li>
      <li><abbr title="W">WED</abbr></li>
      <li><abbr title="T">THU</abbr></li>
      <li><abbr title="F">FRI</abbr></li>
      <li><abbr title="S">SAT</abbr></li>
    </ul>

    <ol class="day-grid">
      <li v-for="(duty, index) in duties"
          :class="{
          ['BACKGROUND-' + duty.dutyColor]: true,
          'month-prev': (duty.month < month),
          'month-next': (duty.month > month),
          'today': isToday(duty),
        }">
        <div class="date container">
          <span v-if="selectedDday" v-text="calcDday(duty)" class="d-day-count"></span>
          <div class="day">
            <span v-text="duty.day"></span>
          </div>
          <div class="schedules">
            <div class="schedule" v-for="schedule in schedulesByDays[index]">
              <span class="schedule=content" v-text="schedule.content"></span>
              <div class="schedule-time-container">
              <span
                  v-if="shouldDisplayStartTime(schedule)"
                  class="start-time single-time"
                  v-text="formattedTime(schedule.startDateTime)"
              />
                <span
                    v-if="shouldDisplayEndTime(schedule)"
                    class="end-time single-time"
                    v-text="formattedTime(schedule.endDateTime)"
                />
              </div>
            </div>
          </div>
        </div>
      </li>
    </ol>
  </div>
  <div th:if="!${member.department}" class="no-data p-5">
    <h3>어느 부서에도 소속되어 있지 않습니다.</h3>
  </div>

  <div class="d-day-list row" v-cloak>
    <div v-for="(dDay, index) in dDays" class="col-6">
      <div class="d-day-item card row"
           v-on:click="dDayToggle(dDay)"
           :data-id="dDay.id"
           :class="{'d-day-private': dDay.isPrivate, 'selected': dDay == selectedDday}"
      >
        <div class="d-day_day col-4">
          <span v-if="!dDay.editMode">{{dDay.dDayText}}</span>
        </div>
        <div class="d-day_content col-8">
          <p v-if="!dDay.editMode">{{dDay.date}}</p>
          <p v-if="!dDay.editMode">{{dDay.title}}</p>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>

<script>
    $(function () {
        const memberId = parseInt("[[${member.id}]]");

        if (document.querySelector('.calendar')) {
            let year = parseInt("[[${year}]]");
            let month = parseInt("[[${month}]]");
            const departmentId = parseInt("[[${member.departmentId}]]");

            const app = new Vue({
                    el: '.body',
                    data: {
                        year: year,
                        month: month,
                        duties: [],
                        schedulesByDays: [],
                        department: {},
                        dDays: [],
                        selectedDday: null,
                    }, mounted() {
                        this.loadDuties(year, month);
                        this.loadSchedule(year, month);
                        this.loadDepartment();
                        this.loadDDays();
                    }, computed: {
                        combinedYearMonth: {
                            get() {
                                return `${this.year}-${this.month.toString().padStart(2, '0')}`;
                            },
                            set(value) {
                                const [year, month] = value.split('-');
                                this.year = parseInt(year);
                                this.month = parseInt(month);
                            },
                        },
                        calcDday() {
                            return (duty) => {
                                const date = new Date(duty.year, duty.month - 1, duty.day);
                                const calc = Math.floor((date.getTime() - new Date(app.selectedDday.date).getTime()) / (1000 * 60 * 60 * 24)) + 1;
                                const dDayText = calc < 0 ? 'D' + calc : calc == 0 ? 'D-Day' : 'D+' + (calc + 1);
                                return dDayText;
                            }
                        },
                    }, watch: {
                        combinedYearMonth() {
                            this.loadDuties(app.year, app.month);
                            this.loadSchedule(app.year, app.month);
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.set('year', app.year);
                            currentUrl.searchParams.set('month', app.month);
                            window.history.replaceState(null, '', currentUrl.toString());
                        },
                    }, methods: {
                        addMonth(month) {
                            const newDate = new Date(app.year, app.month - 1 + month);
                            app.year = newDate.getFullYear();
                            app.month = newDate.getMonth() + 1;
                        },
                        loadDuties(year, month) {
                            $.ajax({
                                url: '/api/duty',
                                type: 'GET',
                                data: {
                                    memberId: memberId,
                                    year: year,
                                    month: month,
                                },
                                success: (data) => {
                                    this.duties = data;
                                }
                            })
                        },
                        loadDDays() {
                            const selectedDdayId = localStorage.getItem('selectedDday_' + memberId);
                            $.ajax({
                                url: '/api/dday/' + memberId,
                                type: 'GET',
                                success: (data) => {
                                    this.dDays = data;
                                    for (const dDay of app.dDays) {
                                        if (dDay.id == selectedDdayId) {
                                            app.selectedDday = dDay;
                                        }
                                        if (dDay.calc == 0) {
                                            dDay.dDayText = 'D-Day';
                                        } else if (dDay.calc < 0) {
                                            dDay.dDayText = 'D+' + -dDay.calc;
                                        } else {
                                            dDay.dDayText = 'D-' + dDay.calc;
                                        }
                                    }
                                }
                            })
                        },
                        dDayToggle(dDay) {
                            if (app.selectedDday == dDay) {
                                app.selectedDday = null;
                                localStorage.removeItem('selectedDday_' + memberId);
                            } else {
                                app.selectedDday = dDay;
                                localStorage.setItem('selectedDday_' + memberId, dDay.id);
                            }
                        },
                        loadSchedule(year, month) {
                            $.ajax({
                                url: '/api/schedules',
                                type: 'GET',
                                data: {
                                    memberId: memberId,
                                    year: year,
                                    month: month,
                                },
                                success: (data) => {
                                    this.schedulesByDays = data;
                                }
                            })
                        },
                        loadDepartment() {
                            fetch(`/api/departments/${departmentId}`)
                                .then(response => response.json())
                                .then(data => {
                                    this.department = data;
                                })
                        },
                        editDuty() {
                            const memberId = document.getElementsByClassName('calendar')[0].getAttribute('data-member_id');
                            window.location.href = `/duty/edit?memberId=${memberId}&year=${(app.year)}&month=${(app.month)}`;
                        },
                        shouldDisplayStartTime(schedule) {
                            const daysFromStart = schedule.daysFromStart;
                            const startDateTime = new Date(schedule.startDateTime);
                            const startHour = startDateTime.getHours().toString().padStart(2, '0');
                            return daysFromStart === 1 && startHour !== '00';
                        },
                        shouldDisplayEndTime(schedule) {
                            const daysFromStart = schedule.daysFromStart;
                            const totalDays = schedule.totalDays;
                            const startDateTime = new Date(schedule.startDateTime);
                            const endDateTime = new Date(schedule.endDateTime);
                            const endHour = endDateTime.getHours().toString().padStart(2, '0');
                            return (
                                daysFromStart === totalDays &&
                                endHour !== '00' &&
                                !(totalDays === 1 && sameDate(startDateTime, endDateTime))
                            );
                        }, formattedTime(startDateTime) {
                            const dateTime = new Date(startDateTime);
                            const hour = dateTime.getHours().toString().padStart(2, '0');
                            const minute = dateTime.getMinutes().toString().padStart(2, '0');
                            return hour + ':' + minute;
                        }, isToday(duty) {
                            const today = new Date();
                            return duty.month === today.getMonth() + 1 && duty.day === today.getDate();
                        }
                    }
                }
            )
        }
    })

    function sameDate(startDateTime, endDateTime) {
        return startDateTime.getTime() == endDateTime.getTime();
    }
</script>
