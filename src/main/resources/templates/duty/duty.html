<!DOCTYPE html>
<head th:replace="~{layout/include::link}" xmlns:v-on="http://www.w3.org/1999/xhtml"/>
<body>

<div th:replace="~{layout/header::header-title(|${member.name}|)}"></div>

<div th:if="${duties}" class="calendar">
  <div class="month-control row">
    <h1>
      <a class="move"
         th:href="@{/duty/{member}(member=${member.name},year=${prevMonth.year}, month=${prevMonth.monthValue})}">
        <i class="bi bi-arrow-left-circle"></i>
      </a>
      <input type="month" th:value="|${year}-${month < 10 ? '0' + month : month}|" onclick="this.showPicker()">
      <a class="move"
         th:href="@{/duty/{member}(member=${member.name},year=${nextMonth.year}, month=${nextMonth.monthValue})}">
        <i class="bi bi-arrow-right-circle"></i>
      </a>
    </h1>
  </div>
  <div class="dutyTypes">
    <span th:each="type : ${dutyTypes}">
      <span th:class="|indicator BACKGROUND-${type.color}|">&nbsp;&nbsp;&nbsp;</span>
      <span th:text="${type.name}"></span>
    </span>
    <button th:if="${#strings.equals(member.id, loginMember?.id) || member.managerId==loginMember?.id}"
            class="edit-btn"
            th:onclick="|window.location.href='@{/duty/edit/{member}(member=${member.name},year=${year}, month=${month})}'|">
      수정<i class="bi bi-pencil-square"></i>
    </button>
  </div>
  <ul class="weekdays">
    <li>
      <abbr title="S">SUN</abbr>
    </li>
    <li>
      <abbr title="M">MON</abbr>
    </li>
    <li>
      <abbr title="T">TUE</abbr>
    </li>
    <li>
      <abbr title="W">WED</abbr>
    </li>
    <li>
      <abbr title="T">THU</abbr>
    </li>
    <li>
      <abbr title="F">FRI</abbr>
    </li>
    <li>
      <abbr title="S">SAT</abbr>
    </li>
  </ul>

  <ol class="day-grid" th:with="today=${#dates.createNow()}">
    <th:block th:each="i : ${#numbers.sequence(0, offset % 7 -1, 1)}">
      <li class="month-prev"/>
    </th:block>
    <th:block th:each="i : ${#numbers.sequence(1, lastDay)}">
      <li th:id="|day-${i}|"
          th:with="duty=${duties.get(i)}"
          th:classappend='|BACKGROUND-${ duty?.dutyColor ?: offColor}${today.getYear()+1900==year and today.getMonth()+1 == month and today.getDate() == i ? " today": "" }|'>
        <div class="date container">
          <div class="day">
            <span th:text='|${i}|'></span>
          </div>
          <div class="schedules">
          </div>
        </div>
      </li>
    </th:block>
    <th:block th:if="(${offset} + ${lastDay}) % 7 > 0"
              th:each="i : ${#numbers.sequence(1, 7 - ((offset + lastDay) % 7) )}">
      <li class="month-next"/>
    </th:block>
  </ol>
</div>
<div th:if="!${duties}" class="no-data p-5">
  <h3>어느 부서에도 소속되어 있지 않습니다.</h3>
</div>

<div class="body">
  <div class="d-day-list row" v-cloak>
    <div v-for="(dDay, index) in dDays" class="col-6">
      <div class="d-day-item card row"
           v-on:click="dDayToggle(dDay)"
           :data-id="dDay.id"
           :class="{'d-day-private': dDay.isPrivate}">
        <div class="d-day_day col-4">
          <span v-if="!dDay.editMode">{{dDay.dDayText}}</span>
        </div>
        <div class="d-day_content col-8">
          <p v-if="!dDay.editMode">{{dDay.date}}</p>
          <p v-if="!dDay.editMode">{{dDay.title}}</p>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>

<script>
    $(function () {
        $('input[type="month"]').on('change', function () {
            let year = $(this).val().split('-')[0];
            let month = $(this).val().split('-')[1];
            window.location.href = window.location.href.split('?')[0] + '?year=' + year + '&month=' + month;
        });

        const memberId = parseInt("[[${member.id}]]");

        if (document.querySelector('.calendar')) {
            const yearAndMonth = $('.month-control input').val().split('-');
            const year = parseInt(yearAndMonth[0]);
            const month = parseInt(yearAndMonth[1]);

            const calendar = new Vue({
                el: '.calendar',
                data: {
                    days: [],
                }, mounted() {
                    this.load();
                }, methods: {
                    load() {
                        $.ajax({
                            url: '/api/schedules',
                            type: 'GET',
                            data: {
                                memberId: memberId,
                                year: year,
                                month: month,
                            },
                            success: (data) => {
                                this.days = data;
                                // TODO: DutyViewController.retrieveMemberDuty model data goes vue binding
                                for (let i = 0; i < data.length; i++) {
                                    const schedules = data[i];
                                    const $day = $('#day-' + (i + 1));
                                    for (const schedule of schedules) {
                                        const daysFromStart = schedule.daysFromStart;
                                        const totalDays = schedule.totalDays;
                                        let $schedule = $('<div class="schedule">');
                                        $schedule.append($('<span class="schedule-content">').text(schedule.content));
                                        const $timeContainer = $('<div class="schedule-time-container">');
                                        const startDateTime = new Date(schedule.startDateTime);
                                        const endDateTime = new Date(schedule.endDateTime);
                                        const startHour = startDateTime.getHours().toString().padStart(2, '0');
                                        if (daysFromStart == 1 && startHour != '00') {
                                            const $startTime = $('<span class="start-time">');
                                            const scheduleMinute = startDateTime.getMinutes().toString().padStart(2, '0');
                                            $startTime.text(startHour + ':' + scheduleMinute);
                                            $timeContainer.append($startTime);
                                        }
                                        const endHour = endDateTime.getHours().toString().padStart(2, '0');
                                        if (daysFromStart == totalDays && endHour != '00' && !(totalDays == 1 && sameDate(startDateTime, endDateTime))) {
                                            const $endTime = $('<span class="end-time">');
                                            const scheduleMinute = endDateTime.getMinutes().toString().padStart(2, '0');
                                            $endTime.text(endHour + ':' + scheduleMinute);
                                            $timeContainer.append($endTime);
                                        }
                                        $schedule.append($timeContainer);
                                        if ($timeContainer.children().length < 2) {
                                            $timeContainer.find('span').addClass('single-time');
                                        }
                                        $day.find('.schedules').append($schedule);
                                    }
                                }
                            }
                        })
                    }
                }
            })
        }

        const app = new Vue({
            el: '.d-day-list',
            data: {
                dDays: [],
                selectedDday: null,
            },
            mounted() {
                this.load();
            },
            updated() {
                this.loadSelectedDday();
            },
            methods: {
                load() {
                    $.ajax({
                        url: '/api/dday/' + memberId,
                        type: 'GET',
                        success: (data) => {
                            this.dDays = data;
                            for (const dDay of app.dDays) {
                                dDay.editMode = false;
                                if (dDay.calc == 0) {
                                    dDay.dDayText = 'D-Day';
                                } else if (dDay.calc < 0) {
                                    dDay.dDayText = 'D+' + -dDay.calc;
                                } else {
                                    dDay.dDayText = 'D-' + dDay.calc;
                                }
                            }
                        }
                    })
                },
                dDayToggle(clickedDday) {
                    $('.d-day-item.selected').removeClass('selected');
                    document.querySelectorAll('span.d-day-count').forEach((span) => {
                        span.remove();
                    })
                    if (app.selectedDday == clickedDday) {
                        app.selectedDday = null;
                        this.saveSelectedDday(null);
                        return;
                    }
                    app.selectedDday = clickedDday;
                    this.saveSelectedDday(app.selectedDday);

                    const element = document.querySelector(`.d-day-item[data-id='${app.selectedDday.id}']`);
                    element.classList.add('selected');

                    const calendarYear = parseInt($("input[type='month']").val().split('-')[0]);
                    const calendarMonth = parseInt($("input[type='month']").val().split('-')[1]);

                    document.querySelectorAll('.day-grid li .date').forEach((li) => {
                        const day = li.querySelector('.day span').innerText
                        const date = new Date(calendarYear, calendarMonth - 1, day);
                        const calc = Math.floor((date.getTime() - new Date(app.selectedDday.date).getTime()) / (1000 * 60 * 60 * 24)) + 1;
                        const dDayText = calc < 0 ? 'D' + calc : calc == 0 ? 'D-Day' : 'D+' + (calc + 1);
                        const countElement = document.createElement('span');
                        countElement.classList.add('d-day-count');
                        countElement.innerText = dDayText;
                        li.prepend(countElement);
                    })
                },
                saveSelectedDday(selectedDday) {
                    if (!selectedDday) {
                        localStorage.removeItem('selectedDday_' + memberId);
                        return;
                    }
                    localStorage.setItem('selectedDday_' + memberId, this.selectedDday.id);
                },
                loadSelectedDday() {
                    const savedSelectedDday = localStorage.getItem('selectedDday_' + memberId);
                    if (savedSelectedDday) {
                        const element = document.querySelector(`.d-day-item[data-id='${savedSelectedDday}']`);
                        element.click();
                    }
                }
            }
        })
    })

    function sameDate(startDateTime, endDateTime) {
        return startDateTime.getTime() == endDateTime.getTime();
    }
</script>
