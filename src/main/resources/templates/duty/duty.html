<div th:unless="${visible}">
  <div class="alert alert-danger" role="alert">
    <p></p><span th:text="${member.name}"></span> 님의 시간표를 조회할 수 없습니다.</p>
    <p>해당 시간표는 <span class="text-bg-warning" th:text="${member.calendarVisibility.label}"></span> 상태입니다.</p>
  </div>
</div>
<div class="duty-vue" v-cloak th:if="${visible}">
  <div class="todo-container" v-if="isMyCalendar">
    <div class="d-flex">
      <div id="add-todo-btn" class="m-0 cursor-pointer fs-2" v-on:click="addTodoModal()">
        <i class="bi bi-journal-plus"></i><small class="ms-2" v-if="todos.length>0" v-text="todos.length"></small>
      </div>
      <div class="d-flex flex-row" id="todo-list-container">
        <div class="d-flex flex-row" id="todo-list">
          <div v-for="todo in todos" class="todo-item" :data-id="todo.id">
            <div class="handle">
              <i class="bi bi-list"></i>
            </div>
            <strong class="todo-text" v-text="todo.title" v-on:click="showTodoDetails(todo)"></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div th:if="${member.department}" class="calendar mt-3" th:attr="data-member_id=${member.id}">
    <div class="month-control row">
      <div class="month-control-left col-md-3">
        <button class="today-button info" v-on:click="today()"><span>Today</span><i
            class="bi bi-arrow-counterclockwise"></i></button>
      </div>
      <div class="col-md-6 monthSelector">
        <a class="move cursor-pointer" v-on:click="addMonth(-1)">
          <i class="bi bi-arrow-left-circle"></i>
        </a>
        <button class="year-month-btn btn text-center" data-bs-toggle="dropdown"
                data-bs-auto-close="outside">
          <span class="currentCalendar" v-text="combinedYearMonth"></span>
        </button>

        <div class="dropdown-menu p-3 shadow">
          <div class="justify-content-between mb-3 monthSelector-header container row">
            <div class="col-md-2">
              <button class="btn today-button" v-on:click="today()">오늘</button>
            </div>
            <div class="col-md-8">
              <div class="m-auto" style="width:fit-content">
                <button class="btn btn-light btn-lg" v-on:click="monthSelector.year-=10">&laquo;</button>
                <button class="btn btn-light btn-lg" v-on:click="monthSelector.year--">&lsaquo;</button>
                <span class="fw-bold fs-1 cur-year m-3" v-text="monthSelector.year"></span>
                <button class="btn btn-light btn-lg" v-on:click="monthSelector.year++">&rsaquo;</button>
                <button class="btn btn-light btn-lg" v-on:click="monthSelector.year+=10">&raquo;</button>
              </div>
            </div>
            <div class="col-md-2 text-end">
              <button class="btn btn-light btn-lg btn-close" v-on:click="closeDropdown"></button>
            </div>
          </div>
          <div class="container">
            <div class="row row-cols-3 g-2">
              <button
                  v-for="(m, index) in Array.from({ length: 12 }, (_, i) => i + 1)"
                  :key="index"
                  :class="{ 'btn btn-outline-secondary col month-btn': true, active: year === monthSelector.year && m === month }"
                  @click="selectMonth(m)"
              >
                {{ m }}월
              </button>
            </div>
          </div>
        </div>
        <a class="move cursor-pointer" v-on:click="addMonth(1)">
          <i class="bi bi-arrow-right-circle"></i>
        </a>
      </div>
      <div class="month-control-right col-md-3 p-0 position-relative">
        <div class="search-bar d-flex align-items-center" v-if="isMyCalendar">
          <form @submit.prevent="search()">
            <div class="d-flex w-100">
              <label>
                <input type="text" class="form-control" placeholder="검색" v-model="searchQuery">
              </label>
              <button class="btn btn-outline-dark" type="submit">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>
        </div>
        <div class="info member-info position-absolute end-0" v-if="!isMyCalendar">
          <i class="bi bi-person-fill"></i>
          <span th:text="${member.name}"></span>
        </div>
      </div>
    </div>
    <div class="duty-table-header">
      <div class="duty-types d-flex">
        <div class="duty-type d-flex" v-for="type in department.dutyTypes">
          <div :class="['indicator', 'BACKGROUND-' + type.color]">
            <span v-text="type.name"></span>
          </div>
          <div class="duty-type-count">
            <span v-text="type.cnt"></span>
          </div>
        </div>
      </div>
      <div class="buttons">
        <button v-if="canEdit && batchEditMode"
                class="edit-btn btn btn-warning"
                v-on:click="showBatchUpdate">한번에 수정
        </button>
        <button v-if="canEdit && batchEditMode && department.dutyBatchTemplate"
                class="btn btn-info"
                v-on:click="uploadBatchFile"
        >시간표 파일 업로드
        </button>

        <button v-if="canEdit && batchEditMode"
                class="edit-btn btn btn-success"
                v-on:click="batchEditMode=false;">편집완료
        </button>
        <button v-if="canEdit && !batchEditMode"
                class="edit-btn btn btn-warning"
                v-on:click="batchEditMode=true;">편집모드
        </button>
      </div>
    </div>
    <div class="day-of-the-week row-7">
      <div><abbr title="일요일">일</abbr></div>
      <div><abbr title="월요일">월</abbr></div>
      <div><abbr title="화요일">화</abbr></div>
      <div><abbr title="수요일">수</abbr></div>
      <div><abbr title="목요일">목</abbr></div>
      <div><abbr title="금요일">금</abbr></div>
      <div><abbr title="토요일">토</abbr></div>
    </div>

    <div class="day-grid row-7" :class="{'editable': canEdit}">
      <div class="DAY"
           :id="formattedDate(duty.year, duty.month, duty.day)"
           v-for="(duty, index) in duties"
           :class="{
          ['BACKGROUND-' + duty.dutyColor]: true,
          'month-prev': (duty.month < month),
          'month-next': (duty.month > month),
          'today': isToday(duty),
          'searchDay' : isSearchDay(duty),
          'holiday': isHoliday(index),
          'has-schedule': hasSchedule(index),
        }"
           v-on:click="viewDayDetail(duty, index)">
        <div class="date container">
          <div class="day-header text-align-left ps-2 position-relative">
            <span class="day" v-text="(duty.month==month?'':duty.month +'/ ')+ duty.day"></span>
            <div class="position-absolute" style="right:10px;top:0">
              <span v-if="selectedDday" v-text="calcDday(duty)" class="d-day-count"></span>
            </div>
          </div>
          <div v-if="!batchEditMode" class="schedules">
            <div v-if="holidaysByDays[index]"
                 class="holiday-info"
                 v-for="holiday in holidaysByDays[index]">
                            <span :class="holiday.isHoliday ? 'holiday' : 'not-holiday'"
                                  v-text="holiday.dateName">

                            </span>
            </div>
            <div class="d-day-schedules"></div>
            <div class="schedule" v-for="schedule in schedulesByDays[index]" v-html="printSchedule(schedule)">
            </div>
          </div>
          <div v-if="batchEditMode" class="duty row">
            <button v-for="type in department.dutyTypes"
                    class="duty-type btn btn-sm btn-outline-dark"
                    v-text="type.name.length > 3 ? type.name.substring(0, 3) : type.name"
                    :class="dutyTypeClasses(type, duty)"
                    :disabled="(duty.dutyType == type.name) || (!duty.dutyType && !type.id)"
                    v-on:click="changeDutyType(duty, type)"
            >
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="d-day-list mt-2 row">
      <div v-for="(dDay, index) in dDays" class="col-6">
        <div class="d-day-item card row shadow-sm p-2 m-1 rounded-4"
             v-on:click="dDayToggle(dDay)"
             :data-id="dDay.id"
             :class="{'d-day-private': dDay.isPrivate, 'selected': dDay == selectedDday}"
        >
          <div class="d-day_day col-4 m-auto">
            <span v-if="!dDay.editMode">{{dDay.dDayText}}</span>
          </div>
          <div class="d-day_content col-8">
            <p class="m-1 text-muted" v-if="!dDay.editMode">{{dDay.date}}</p>
            <p v-if="!dDay.editMode">{{dDay.title}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div th:if="!${member.department}" class="no-department p-5">
    <h3>어느 부서에도 소속되어 있지 않습니다.</h3>
  </div>

  <div id="todo-details-modal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="todo-details-title">할일 상세</h5>
        </div>
        <div class="modal-body">
          <div class="modal-body">
            <div class="input-group mb-2">
              <span class="input-group-text" id="todo-title-input">제목</span>
              <input type="text" class="todo-title form-control" aria-labelledby="todo-title-input"
                     aria-label="title" :readonly="!editTodoMode"/>
            </div>
            <div class="input-group">
              <span class="input-group-text" id="todo-content-input">내용</span>
              <textarea rows="4" class="todo-content form-control" aria-label="content"
                        aria-labelledby="todo-content-input"
                        :readonly="!editTodoMode"></textarea>
            </div>
          </div>
          <div class="text-right">
            <p class="text-muted todo-date"></p>
            <button type="button" class="btn btn-info btn-sm" v-on:click="editTodoMode=true" v-if="!editTodoMode">수정
            </button>
            <button type="button" class="btn btn-success btn-sm" v-on:click="updateTodo()" v-if="editTodoMode">저장
            </button>
            <button type="button" class="btn btn-danger btn-sm" v-on:click="deleteTodo()">삭제</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
      class="modal fade"
      id="add-todo-modal"
      tabindex="-1"
      aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">할일 추가</h5>
        </div>
        <div class="modal-body">
          <label class="form-control fs-3 mb-2">할일 제목
            <input
                type="text"
                class="form-control todo-title"
                name="title"
                placeholder="할일 제목을 입력하세요."
            />
          </label>
          <label class="form-control fs-3">할일 상세(선택 사항)
            <textarea
                class="form-control todo-content"
                name="content"
                rows="4"
                placeholder="해당 할일에 대한 상세 설명을 입력하세요"
            ></textarea>
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" v-on:click="addTodo()">저장</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </div>
    </div>
  </div>

  <div id="search-result-modal" class="modal fade fs-3" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <span class="fs-2"><b v-text="searchQuery"></b> 검색 결과</span>
          <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped">
            <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">내용</th>
              <th scope="col">작성자</th>
              <th scope="col">시작일</th>
              <th scope="col">종료일</th>
            </tr>
            </thead>
            <tbody>
            <tr class="search-result-row" v-for="(item, index) in searchResults.content" :key="index"
                v-on:click="moveToSearch(item)">
              <th scope="row">{{ index + 1 + (searchResults.pageable.pageNumber * searchResults.pageable.pageSize) }}
              </th>
              <td>{{ item.content }}</td>
              <td>{{ item.author }}</td>
              <td>{{ formattedDateYMD(item.startDateTime) }}</td>
              <td>{{ formattedDateYMD(item.endDateTime) }}</td>
            </tr>
            </tbody>
          </table>
          <nav v-if="searchResults.totalPages > 1">
            <ul class="pagination justify-content-center">
              <li class="page-item" :class="{ disabled: searchResults.first }">
                <button class="page-link" @click="search(searchResults.pageable.pageNumber - 1)">이전</button>
              </li>
              <li class="page-item" v-if="startPage > 1">
                <button class="page-link" @click="search(0)">1</button>
              </li>
              <li class="page-item disabled" v-if="startPage > 2">
                <span class="page-link">...</span>
              </li>
              <li class="page-item"
                  v-for="page in pagesToShow"
                  :key="page"
                  :class="{ active: page - 1 === searchResults.pageable.pageNumber }">
                <button class="page-link" @click="search(page - 1)">{{ page }}</button>
              </li>
              <li class="page-item disabled" v-if="endPage < searchResults.totalPages - 1">
                <span class="page-link">...</span>
              </li>
              <li class="page-item" v-if="endPage < searchResults.totalPages">
                <button class="page-link" @click="search(searchResults.totalPages - 1)">{{ searchResults.totalPages }}
                </button>
              </li>
              <li class="page-item" :class="{ disabled: searchResults.last }">
                <button class="page-link" @click="search(searchResults.pageable.pageNumber + 1)">다음</button>
              </li>
            </ul>
          </nav>

        </div>
      </div>
    </div>
  </div>

  <div id="detail-view-modal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" v-if="detailView">
        <div class="modal-header">
          <p class="current-date-label"
             v-text="detailView?.year + '년 ' + detailView?.month + '월 ' + detailView?.day + '일'"></p>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="dutyTypes">
            <form>
              <div v-for="type in department.dutyTypes" class="pretty p-round p-pulse">
                <input type="radio" name="dutyType"
                       :checked="isDutyType(detailView, type)"
                       v-on:click="changeDutyTypeWithPopup(detailView, type)"
                />
                <div class="state p-primary">
                  <label v-text="type.name"></label>
                </div>
              </div>
            </form>
          </div>
          <div class="schedules mt-4">
            <div class="schedule card shadow"
                 v-if="!isCreateScheduleMode && (editingSchedule.id == null || isEditing(schedule) )"
                 :class="['visibility-' + schedule.visibility]"
                 v-for="(schedule, s_index) in schedulesByDays[detailView.index]"
                 :id="'schedule-' + schedule.id">
              <div v-if="!isEditing(schedule)" v-html="printSchedule(schedule)"></div>
              <div v-if="isEditing(schedule)" class="schedule-edit">
                <label>일정 제목 <span class="content-length"
                                   v-text="editingSchedule.content.length + ' / ' + schedule_content_max_length"></span>
                  <small class="help-note">달력에 표시되는 제목이에요 <i class="bi bi-info-circle-fill"></i></small>
                </label>
                <input class="form-control" placeholder="일정을 입력하세요." :maxlength="schedule_content_max_length"
                       v-model="editingSchedule.content"/>
                <label>일정 상세<small class="help-note">달력에 표시되지 않고 클릭했을때만 보여져요 <i
                    class="bi bi-info-circle-fill"></i></small>
                </label>
                <textarea class="form-control" placeholder="(선택사항) 일정 상세정보를 입력하세요." rows="4"
                          v-model="editingSchedule.description"></textarea>
                <label>시작일
                  <input type="date" class="form-control" v-model="editingSchedule.startDate" readonly hidden/>
                </label>
                <p class="form-control bg-light" v-text="editingSchedule.startDate" readonly=""></p>
                <label>시작시간 (선택사항)
                  <input type="time" class="form-control" v-model="editingSchedule.startTime"/>
                </label>
                <label>종료일 (선택사항)
                  <input type="datetime-local" class="form-control"
                         v-model="editingSchedule.endDateTime"/>
                </label>
                <label>공개설정</label>
                <div class="schedule-visibility">
                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PUBLIC" v-model="editingSchedule.visibility"/>
                    <div class="state p-success-o">
                      <label>전체</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FRIENDS" v-model="editingSchedule.visibility"/>
                    <div class="state p-warning-o">
                      <label>친구</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FAMILY" v-model="editingSchedule.visibility"/>
                    <div class="state p-warning-o">
                      <label>가족</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PRIVATE" v-model="editingSchedule.visibility"/>
                    <div class="state p-danger-o">
                      <label>비공개</label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="buttons mt-3" v-if="!isEditing(schedule)">
                <template v-if="schedule.isTagged && isMyCalendar">
                  <button class="btn btn-danger" v-on:click="untagSelf(schedule)">태그제거</button>
                </template>
                <template v-else>
                  <template
                      v-if="schedulesByDays[detailView.index].length > detailView.scheduleStartDiffCount + 1 && dutyAndDateTimeSame(detailView, schedule.startDateTime)">
                    <button
                        :disabled="s_index == schedulesByDays[detailView.index].length -1 || schedulesByDays[detailView.index][s_index+1].isTagged"
                        v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index+1])"
                        class="btn btn-secondary"
                    >
                      <i class="bi bi-arrow-down-square"></i>
                    </button>
                    <button :disabled="s_index <= detailView.scheduleStartDiffCount"
                            v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index-1])"
                            class="btn btn-secondary">
                      <i class="bi bi-arrow-up-square"></i>
                    </button>
                  </template>
                  <button class="btn btn-info" v-on:click="scheduleEditMode(schedule)">수정</button>
                  <button class="btn btn-danger" v-on:click="deleteSchedule(schedule)">삭제</button>
                </template>
              </div>
              <div class="buttons mt-3" v-if="isEditing(schedule)">
                <button class="btn btn-success" v-on:click="editSchedule()">저장</button>
                <button class="btn btn-secondary" v-on:click="cancelEditMode()">취소</button>
              </div>
            </div>
            <div class="schedule card shadow" v-if="isCreateScheduleMode">
              <div class="schedule-edit">
                <label>일정 추가 <span class="content-length"
                                   v-text="createSchedule.content.length + ' / ' + schedule_content_max_length"></span>
                  <small class="help-note">달력에 표시되는 제목이에요 <i class="bi bi-info-circle-fill"></i></small>
                  <input class="form-control" placeholder="일정 제목을 입력하세요." :maxlength="schedule_content_max_length"
                         v-model="createSchedule.content"/>
                </label>
                <label>일정 상세<small class="help-note">달력에 표시되지 않고 클릭했을때만 보여져요 <i
                    class="bi bi-info-circle-fill"></i></small>
                  <textarea class="form-control" placeholder="(선택사항) 일정 상세정보를 입력하세요." rows="4"
                            v-model="createSchedule.description"></textarea>
                </label>
                <label>시작일
                  <input type="date" class="form-control" v-model="createSchedule.startDate" readonly hidden/>
                </label>
                <p class="form-control bg-light" v-text="createSchedule.startDate" readonly></p>
                <label>시작시간 (선택사항)
                  <input type="time" class="form-control" v-model="createSchedule.startTime"/>
                </label>
                <label>종료일시 (선택사항)
                  <input type="datetime-local" class="form-control" v-model="createSchedule.endDateTime"
                         :min="createSchedule.startDateTime"/>
                </label>
                <label>공개설정</label>
                <div class="schedule-visibility">
                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PUBLIC" v-model="createSchedule.visibility"/>
                    <div class="state p-success-o">
                      <label>전체</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FRIENDS" v-model="createSchedule.visibility"/>
                    <div class="state p-info-o">
                      <label>친구</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FAMILY" v-model="createSchedule.visibility"/>
                    <div class="state p-warning-o">
                      <label>가족</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PRIVATE" v-model="createSchedule.visibility"/>
                    <div class="state p-danger-o">
                      <label>비공개</label>
                    </div>
                  </div>
                </div>
                <div class="buttons mt-3">
                  <button id="add-btn" class="btn btn-success" v-on:click="saveSchedule">추가</button>
                  <button class="btn btn-secondary" v-on:click="cancelCreateSchedule">취소</button>
                </div>
              </div>
            </div>
          </div>
          <div class="schedule-add-button card shadow"
               v-if="!isCreateScheduleMode && !editingSchedule.id">
            <button class="btn btn-success" v-on:click="scheduleCreateMode()">일정 추가</button>
          </div>
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>

</div>

<script>
    $(function () {
        const memberId = parseInt("[[${member.id}]]");
        const departmentId = parseInt("[[${member.departmentId}]]");
        const loginMemberId = parseInt("[[${loginMember?.id}]]");
        const managerId = parseInt("[[${member.managerId}]]");
        const isMyCalendar = loginMemberId === memberId;

        const visible = "[[${visible}]]" === 'true';
        if (!visible)
            return;

        const app = new Vue({
                el: '.duty-vue',
                data: {
                    year: parseInt("[[${year}]]"),
                    month: parseInt("[[${month}]]"),
                    searchDay: parseInt("[[${day}]]"),
                    duties: [],
                    schedulesByDays: [],
                    holidaysByDays: [],
                    department: {},
                    dDays: [],
                    selectedDday: null,
                    detailView: {
                        'dutyColor': '',
                        'dutyType': '',
                        'id': '',
                        'month': '',
                        'year': '',
                        'day': '',
                    },
                    batchEditMode: false,
                    isCreateScheduleMode: false,
                    calendarVisibility: "[[${member.calendarVisibility}]]",
                    monthSelector: {
                        year: parseInt("[[${year}]]"),
                    },
                    schedule_content_max_length: 30,
                    createSchedule: {
                        content: '',
                        description: '',
                        startDateTime: '',
                        startDate: '',
                        startTime: '',
                        startDateTimeOld: '',
                        endDateTime: '',
                        visibility: 'FAMILY',
                    },
                    editingSchedule: {
                        id: '',
                        content: '',
                        description: '',
                        startDateTime: '',
                        startDate: '',
                        startTime: '',
                        startDateTimeOld: '',
                        endDateTime: '',
                        visibility: '',
                    },
                    friends: [],
                    todos: [],
                    editTodoMode: false,
                    dDaysPromise: null,
                    departmentPromise: null,
                    searchQuery: '',
                    searchResults: [],
                }, mounted() {
                    if (departmentId) {
                        this.loadDepartment();
                        this.loadDuties(this.year, this.month);
                    }
                    this.loadSchedule(this.year, this.month);
                    this.loadHolidays(this.year, this.month);
                    this.loadFriends();
                    this.loadDDays();
                    if (isMyCalendar) {
                        this.loadTodos();
                    }

                    document.addEventListener('click', function (event) {
                        if (event.target && event.target.matches('.schedule-tag-add')) {
                            event.target.querySelector('select').focus();
                        }
                    });

                    document.addEventListener('change', function (event) {
                        if (event.target && event.target.matches('.schedule-tag-add select')) {
                            const selectedOption = event.target.options[event.target.selectedIndex];
                            const scheduleId = event.target.closest('.schedule').id.replace('schedule-', '');
                            const friendId = selectedOption.getAttribute('data-id');
                            app.addTag(scheduleId, friendId);
                        }
                    });
                    document.addEventListener('click', function (event) {
                        if (event.target && event.target.matches('#detail-view-modal .schedule-tag.tagged-false')) {
                            const scheduleId = event.target.closest('.schedule').id.replace('schedule-', '');
                            const friendId = event.target.getAttribute('data-id');
                            app.untag(scheduleId, friendId);
                        }
                    });
                    this.initSortable();
                }, computed: {
                    currentCalendar: {
                        get() {
                            const day = this.searchDay || -1;
                            return `${this.year}-${this.month.toString().padStart(2, '0')}-${day}`;
                        },
                    },
                    combinedYearMonth: {
                        get() {
                            return `${this.year}-${this.month.toString().padStart(2, '0')}`;
                        }
                    },
                    canEdit() {
                        return loginMemberId === memberId || loginMemberId === managerId;
                    },
                    isMyCalendar() {
                        return loginMemberId === memberId;
                    },
                    calcDday() {
                        return (duty) => {
                            const date = new Date(duty.year, duty.month - 1, duty.day);
                            const calc = Math.floor((date.getTime() - new Date(app.selectedDday.date).getTime()) / (1000 * 60 * 60 * 24)) + 1;
                            return calc < 0 ? 'D' + calc : calc === 0 ? 'D-Day' : 'D+' + (calc + 1);
                        }
                    },
                    printSchedule() {
                        return (schedule) => {
                            let content = schedule.content.replace(/\n/g, '<br>');
                            if (schedule.totalDays > 1) {
                                content += '[' + schedule.daysFromStart + '/' + schedule.totalDays + '] ';
                            }
                            const tags = []
                            schedule.tags.forEach(tag => {
                                if (tag.id !== memberId) {
                                    tags.push({
                                        name: tag.name,
                                        id: tag.id,
                                    });
                                }
                            });
                            if (schedule.isTagged) {
                                tags.push({name: schedule.owner});
                            }
                            let scheduleElement = `<p class="schedule-content">${schedule.visibility === 'PRIVATE' ? '<i class="bi bi-lock-fill"></i>' : ''} ${content} ${schedule.description ? '<i class="has-description bi bi-chat-left-text"></i>' : ''}<small>${app.printScheduleTime(schedule)}</small></p>`;
                            if (schedule.description) {
                                scheduleElement += '<div class="schedule-description"><hr>' + schedule.description.replace(/\n/g, '<br>') + '</div>';
                            }
                            let tagElements = ''
                            if (tags.length > 0) {
                                tagElements += tags.map(tag => {
                                    return `<span class="schedule-tag tagged-${schedule.isTagged}" data-id="${tag.id}" >${tag.name} </span>`;
                                }).join('');
                            }
                            if (!schedule.isTagged && app.friends.length > 0) {
                                let tagFriendAria = `
                                      <span class="schedule-tag schedule-tag-add">
                                        <select>
                                        <option>태그</option>
                                        ${app.friends.map(friend => {
                                    if (tags.find(tag => tag.id === friend.id)) {
                                        return '';
                                    }
                                    return `<option data-id="${friend.id}">[${friend.department}] ${friend.name}</option>`;
                                }).join('')}
                                      </select>
                                      </span>`;
                                tagElements += tagFriendAria;
                            }
                            return scheduleElement + `<div class="schedule-tags">${tagElements}</div>`;
                        }
                    },
                    printScheduleTime() {
                        return (schedule) => {
                            let result = '';
                            if (app.shouldDisplayStartTime(schedule)) {
                                const startTime = app.formattedTime(schedule.startDateTime);
                                result += '(' + startTime;
                                if (app.shouldDisplayEndTime(schedule)) {
                                    const endTime = app.formattedTime(schedule.endDateTime);
                                    return result + '~' + endTime + ')';
                                }
                                return result + ')';
                            }

                            if (app.shouldDisplayEndTime(schedule)) {
                                const endTime = app.formattedTime(schedule.endDateTime);
                                return result + ' (~' + endTime + ')';
                            }
                            return result;
                        }
                    }
                    ,
                    shouldDisplayStartTime() {
                        return (schedule) => {
                            const daysFromStart = schedule.daysFromStart;
                            const startDateTime = new Date(schedule.startDateTime);
                            const startHour = startDateTime.getHours().toString().padStart(2, '0');
                            const startMinute = startDateTime.getMinutes().toString().padStart(2, '0');
                            return daysFromStart === 1 && !(startHour === '00' && startMinute === '00');
                        }
                    }
                    ,
                    shouldDisplayEndTime() {
                        return (schedule) => {
                            const daysFromStart = schedule.daysFromStart;
                            const totalDays = schedule.totalDays;
                            const startDateTime = new Date(schedule.startDateTime);
                            const endDateTime = new Date(schedule.endDateTime);
                            const endHour = endDateTime.getHours().toString().padStart(2, '0');
                            const endMinute = endDateTime.getMinutes().toString().padStart(2, '0');
                            return (daysFromStart === totalDays)
                                && !(endHour === '00' && endMinute === '00')
                                && !(totalDays === 1 && app.sameDateTime(startDateTime, endDateTime));
                        }
                    }
                    ,
                    dutyAndDateTimeSame() {
                        return (duty, dateTimeString) => {
                            const year = duty.year;
                            const month = duty.month - 1;
                            const day = duty.day;
                            const dateTime = new Date(dateTimeString);
                            return year === dateTime.getFullYear() && month === dateTime.getMonth() && day === dateTime.getDate();
                        }
                    }
                    ,
                    hasSchedule() {
                        return (index) => {
                            return this.schedulesByDays[index] && this.schedulesByDays[index].length > 0;
                        }
                    },
                    startPage() {
                        const currentPage = this.searchResults.pageable.pageNumber + 1;
                        return Math.max(1, currentPage - 5);
                    },
                    endPage() {
                        const currentPage = this.searchResults.pageable.pageNumber + 1;
                        const totalPages = this.searchResults.totalPages;
                        return Math.min(totalPages, currentPage + 5);
                    },
                    pagesToShow() {
                        const pages = [];
                        for (let i = this.startPage; i <= this.endPage; i++) {
                            pages.push(i);
                        }
                        return pages;
                    }
                },
                watch: {
                    currentCalendar() {
                        this.loadDuties(app.year, app.month);
                        this.loadSchedule(app.year, app.month);
                        this.loadHolidays(app.year, app.month);
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('year', app.year);
                        currentUrl.searchParams.set('month', app.month);
                        currentUrl.searchParams.set('day', app.searchDay);
                        if (!app.searchDay) {
                            currentUrl.searchParams.delete('day');
                        }
                        window.history.replaceState(null, '', currentUrl.toString());
                        app.monthSelector.year = app.year;
                    }
                    ,
                    'createSchedule.startTime':
                        function () {
                            app.createSchedule.startDateTime = app.createSchedule.startDate + 'T' + app.createSchedule.startTime;
                            if (app.createSchedule.startDateTimeOld === app.createSchedule.endDateTime || app.createSchedule.startDateTime > app.createSchedule.endDateTime) {
                                app.createSchedule.endDateTime = app.createSchedule.startDateTime;
                            }
                            app.createSchedule.startDateTimeOld = app.createSchedule.startDateTime;
                        }
                    ,
                    'editingSchedule.startTime':
                        function () {
                            app.editingSchedule.startDateTime = app.editingSchedule.startDate + 'T' + app.editingSchedule.startTime;
                            if (app.editingSchedule.startDateTimeOld === app.editingSchedule.endDateTime || app.editingSchedule.startDateTime > app.editingSchedule.endDateTime) {
                                app.editingSchedule.endDateTime = app.editingSchedule.startDateTime;
                            }
                            app.editingSchedule.startDateTimeOld = app.editingSchedule.startDateTime;
                        }
                    ,
                },
                methods: {
                    addMonth(month) {
                        const newDate = new Date(app.year, app.month - 1 + month);
                        app.year = newDate.getFullYear();
                        app.month = newDate.getMonth() + 1;
                        app.searchDay = null;
                    },
                    today() {
                        const today = new Date();
                        app.year = today.getFullYear();
                        app.month = today.getMonth() + 1;
                        app.searchDay = null;
                        app.monthSelector.year = app.year;
                        app.closeDropdown();
                    },
                    closeDropdown() {
                        const dropdownElement = document.querySelector('.dropdown-menu');
                        const dropdownInstance = new bootstrap.Dropdown(dropdownElement, {autoClose: true});
                        dropdownInstance.hide();
                    },
                    selectMonth(month) {
                        app.year = app.monthSelector.year;
                        app.month = month;
                        app.searchDay = null;
                        app.closeDropdown();
                    },
                    loadDuties(year, month) {
                        $.ajax({
                            url: '/api/duty',
                            type: 'GET',
                            data: {
                                memberId: memberId,
                                year: year,
                                month: month,
                            },
                            success: (data) => {
                                this.duties = data;
                                this.departmentPromise.then(() => {
                                    this.setDutyCounts();
                                });
                                this.dDaysPromise.then(() => {
                                    this.checkDDays();
                                });
                            }
                        })
                    },
                    setDutyCounts() {
                        let offCnt = new Date(app.year, app.month, 0).getDate();
                        this.department.dutyTypes.forEach(dutyType => {
                            this.$set(dutyType, 'cnt', 0);
                        });
                        this.duties.forEach(duty => {
                            if (duty.month !== this.month) {
                                return;
                            }
                            this.department.dutyTypes.forEach(dutyType => {
                                if (dutyType.id && dutyType.name === duty.dutyType) {
                                    this.$set(dutyType, 'cnt', dutyType.cnt + 1);
                                    offCnt--;
                                }
                            });
                        });
                        this.department.dutyTypes.forEach(dutyType => {
                            if (!dutyType.id) {
                                this.$set(dutyType, 'cnt', offCnt);
                            }
                        });
                    },
                    loadDDays() {
                        this.dDaysPromise = new Promise((resolve) => {
                            $.ajax({
                                url: '/api/dday/' + memberId,
                                type: 'GET',
                                success: (data) => {
                                    this.dDays = data;
                                    const selectedDdayId = parseInt(localStorage.getItem('selectedDday_' + memberId));
                                    for (const dDay of app.dDays) {
                                        if (dDay.id === selectedDdayId) {
                                            app.selectedDday = dDay;
                                        }
                                        if (dDay.calc === 0) {
                                            dDay.dDayText = 'D-Day';
                                        } else if (dDay.calc < 0) {
                                            dDay.dDayText = 'D+' + -dDay.calc;
                                        } else {
                                            dDay.dDayText = 'D-' + dDay.calc;
                                        }
                                    }
                                    resolve();
                                }
                            })
                        });
                    }
                    ,
                    checkDDays() {
                        $('.d-day-schedules').html('');
                        for (const dDay of app.dDays) {
                            const dayElement = document.getElementById(dDay.date);
                            if (dayElement) {
                                let scheduleElement = document.createElement('div');
                                scheduleElement.classList.add('schedule', 'd-day-schedule');
                                scheduleElement.innerHTML = '<i class="bi bi-calendar-check"></i> ' + dDay.title;
                                dayElement.querySelector('.d-day-schedules').prepend(scheduleElement);
                            }
                        }
                    }
                    ,
                    dDayToggle(dDay) {
                        if (app.selectedDday == dDay) {
                            app.selectedDday = null;
                            localStorage.removeItem('selectedDday_' + memberId);
                        } else {
                            app.selectedDday = dDay;
                            localStorage.setItem('selectedDday_' + memberId, dDay.id);
                        }
                    }
                    ,
                    loadSchedule(year, month) {
                        $.ajax({
                            url: '/api/schedules',
                            type: 'GET',
                            data: {
                                memberId: memberId,
                                year: year,
                                month: month,
                            },
                            success: (data) => {
                                this.schedulesByDays = data;
                            }
                        })
                    }
                    ,
                    loadDepartment() {
                        this.departmentPromise = new Promise((resolve) => {
                            fetch(`/api/departments/${departmentId}`)
                                .then(response => response.json())
                                .then(data => {
                                    this.department = data;
                                    resolve();
                                })
                        });
                    },
                    editDuty() {
                        const memberId = document.getElementsByClassName('calendar')[0].getAttribute('data-member_id');
                        window.location.href = `/duty/edit?memberId=${memberId}&year=${(app.year)}&month=${(app.month)}`;
                    }
                    ,
                    formattedTime(timeString) {
                        const dateTime = new Date(timeString);
                        const hour = dateTime.getHours() === 12 ? 12 : dateTime.getHours() % 12;
                        let minute = '';
                        if (dateTime.getMinutes() !== 0) {
                            minute = ':' + dateTime.getMinutes().toString().padStart(2, '0');
                        }
                        return hour + minute + (dateTime.getHours() >= 12 ? 'PM ' : 'AM');
                    },
                    formattedDateYMD(dateTimeString) {
                        return new Date(dateTimeString).toISOString().split('T')[0].replaceAll('-', '.');
                    },
                    formattedDate(year, month, day) {
                        month = (month < 10) ? '0' + month : month;
                        day = (day < 10) ? '0' + day : day;
                        return year + '-' + month + '-' + day;
                    },
                    isToday(duty) {
                        const today = new Date();
                        return duty.year === today.getFullYear() && duty.month === today.getMonth() + 1 && duty.day === today.getDate();
                    },
                    isSearchDay(duty) {
                        return duty.year === app.year && duty.month === app.month && duty.day === app.searchDay;
                    },
                    isHoliday(index) {
                        const holidays = app.holidaysByDays[index];
                        if (!holidays || holidays.length === 0) {
                            return false;
                        }
                        for (const holiday of holidays) {
                            if (holiday.isHoliday)
                                return true;
                        }
                        return false;
                    }
                    ,
                    viewDayDetail(duty, index) {
                        if (app.batchEditMode || !app.canEdit) {
                            return;
                        }
                        app.isCreateScheduleMode = false;
                        $('#detail-view-modal').modal('show');
                        app.detailView = duty;
                        app.detailView.index = index;
                        app.detailView.scheduleStartDiffCount = app.schedulesByDays[index].length;
                        for (const schedule of app.schedulesByDays[index]) {
                            if (app.dutyAndDateTimeSame(duty, schedule.startDateTime)) {
                                app.detailView.scheduleStartDiffCount--;
                            }
                        }
                        app.resetCreateSchedule();
                        app.cancelEditMode();
                    }
                    ,
                    resetCreateSchedule() {
                        app.createSchedule = {
                            content: '',
                            description: '',
                            startDateTime: app.formattedDateTime(app.detailView),
                            startDate: app.formattedDate(app.detailView.year, app.detailView.month, app.detailView.day),
                            startTime: '00:00',
                            endDateTime: app.formattedDateTime(app.detailView),
                            visibility: 'FAMILY',
                        }
                    }
                    ,
                    isDutyType(duty, dutyType) {
                        if (duty?.dutyType) {
                            return dutyType.name === duty.dutyType
                        }
                        return !dutyType.id
                    }
                    ,
                    changeDutyTypeWithPopup(duty, type) {
                        this.changeDutyType(duty, type);
                        Swal.fire({
                            icon: 'success',
                            title: '변경되었습니다.',
                            showConfirmButton: false,
                            timer: sweetAlTimer / 3,
                        });
                    },
                    changeDutyType(duty, type) {
                        $.ajax({
                            url: '/api/duty/change',
                            type: 'PUT',
                            data: JSON.stringify({
                                year: duty.year,
                                month: duty.month,
                                day: duty.day,
                                dutyTypeId: type.id,
                                memberId: memberId,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                app.$set(duty, 'dutyType', type.name);
                                app.$set(duty, 'dutyColor', type.color);
                                app.setDutyCounts();
                            },
                            fail: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                            }
                        })
                    },
                    formattedDateTime(duty) {
                        const month = duty.month.toString().padStart(2, '0');
                        const day = duty.day.toString().padStart(2, '0');
                        return `${duty.year}-${month}-${day}T00:00`;
                    },
                    scheduleCreateMode() {
                        app.isCreateScheduleMode = true;
                        const schedules = document.querySelector('#detail-view-modal .schedules');
                    },
                    cancelCreateSchedule() {
                        app.isCreateScheduleMode = false;
                        app.resetCreateSchedule();
                    }
                    ,
                    saveSchedule() {
                        if (!app.isValidContent(app.createSchedule.content)) {
                            return;
                        }
                        if (!app.isValidDateTime(app.createSchedule.startDateTime, app.createSchedule.endDateTime)) {
                            return;
                        }
                        const addArea = $('.schedule-add');
                        addArea.waitMe();
                        $.ajax({
                            url: '/api/schedules',
                            type: 'POST',
                            data: JSON.stringify({
                                memberId: memberId,
                                content: app.createSchedule.content,
                                description: app.createSchedule.description,
                                startDateTime: toLocalISOString(new Date(app.createSchedule.startDateTime)),
                                endDateTime: toLocalISOString(new Date(app.createSchedule.endDateTime)),
                                visibility: app.createSchedule.visibility,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                // SAVED
                                app.resetCreateSchedule();
                                app.loadSchedule(app.year, app.month);
                                app.isCreateScheduleMode = false;
                            },
                            error: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                            }, complete: () => {
                                addArea.waitMe('hide');
                            }
                        })
                    }
                    ,
                    scheduleEditMode(schedule) {
                        app.cancelCreateSchedule();
                        app.editingSchedule.id = schedule.id;
                        app.editingSchedule.content = schedule.content;
                        app.editingSchedule.description = schedule.description;
                        app.editingSchedule.startDateTime = schedule.startDateTime;
                        app.editingSchedule.startDate = schedule.startDateTime.split('T')[0];
                        app.editingSchedule.startTime = schedule.startDateTime.split('T')[1];
                        app.editingSchedule.endDateTime = schedule.endDateTime;
                        app.editingSchedule.visibility = schedule.visibility;
                    }
                    ,
                    cancelEditMode() {
                        app.editingSchedule.id = null;
                        app.editingSchedule.content = '';
                        app.editingSchedule.description = '';
                        app.editingSchedule.startDateTime = '';
                        app.editingSchedule.endDateTime = '';
                    }
                    ,
                    isEditing(schedule) {
                        return app.editingSchedule.id === schedule.id;
                    }
                    ,
                    editSchedule() {
                        const schedule = app.editingSchedule;
                        if (!app.isValidContent(schedule.content)) {
                            return;
                        }
                        if (!app.isValidDateTime(schedule.startDateTime, schedule.endDateTime)) {
                            return;
                        }

                        const editArea = $('#schedule-' + schedule.id);
                        editArea.waitMe();
                        $.ajax({
                            url: '/api/schedules/' + schedule.id,
                            type: 'PUT',
                            data: JSON.stringify({
                                content: schedule.content,
                                description: schedule.description,
                                startDateTime: toLocalISOString(new Date(schedule.startDateTime)),
                                endDateTime: toLocalISOString(new Date(schedule.endDateTime)),
                                memberId: memberId,
                                visibility: schedule.visibility,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                app.cancelEditMode();
                                app.loadSchedule(app.year, app.month);
                            },
                            error: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                            }, complete: () => {
                                editArea.waitMe('hide');
                            }
                        })
                    }
                    ,
                    swapSchedule(schedule1, schedule2) {
                        $('#detail-view-modal .schedules').waitMe();
                        if (!schedule1 || !schedule2 || schedule1 == schedule2) {
                            return;
                        }
                        fetch(`/api/schedules/${schedule1.id}/position?id2=${schedule2.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                        }).then((response) => {
                            $('.schedules').waitMe('hide');
                            if (response.ok) {
                                app.loadSchedule(app.year, app.month);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '순서 변경에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                            }
                        });
                    }
                    ,
                    deleteSchedule(schedule) {
                        Swal.fire({
                            title: '일정을 삭제하시겠습니까?',
                            html: `다음의 일정을 삭제합니다.<br/>[${schedule.content}]<br/> 삭제된 일정은 복구할 수 없습니다.`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#999',
                            confirmButtonText: '삭제',
                            cancelButtonText: '취소',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const deleteArea = $('#schedule-' + schedule.id);
                                deleteArea.waitMe();
                                $.ajax({
                                    url: '/api/schedules/' + schedule.id,
                                    type: 'DELETE',
                                    success: (data) => {
                                        app.loadSchedule(app.year, app.month);
                                    },
                                    error: (data) => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: '삭제에 실패했습니다.',
                                            showConfirmButton: false,
                                            timer: sweetAlTimer
                                        });
                                    }, complete: () => {
                                        deleteArea.waitMe('hide');
                                    }
                                })
                            }
                        })
                    }
                    ,
                    dutyTypeClasses(type, duty) {
                        const departmentLength = app.department.dutyTypes.length;
                        const colClass = (departmentLength === 2 || departmentLength === 4) ? 'col-md-6' : 'col-md-4';
                        return {
                            ['BACKGROUND-' + type.color]: true,
                            selected: type.id === duty.dutyTypeId,
                            [colClass]: true,
                        };
                    }
                    ,
                    async loadHolidays(year, month) {
                        const response = await fetch(`/api/holidays?year=${year}&month=${month}`);

                        if (!response.ok) {
                            Swal.fire({
                                icon: 'error',
                                title: '휴무일 정보를 불러오는데 실패했습니다.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            return;
                        }

                        this.holidaysByDays = await response.json();
                    }
                    ,
                    loadFriends() {
                        if (!loginMemberId || !isMyCalendar) {
                            return;
                        }
                        fetch('/api/friends')
                            .then(async response => {
                                if (!response.ok) {
                                    Swal.fire({
                                        icon: 'error',
                                        title: '친구 목록을 불러오는데 실패했습니다.',
                                        showConfirmButton: false,
                                        timer: sweetAlTimer
                                    });
                                    return;
                                }
                                this.friends = await response.json();
                            });
                    },
                    addTag(scheduleId, friendId) {
                        fetch(`/api/schedules/${scheduleId}/tags/${friendId}`, {
                            method: 'POST',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '태그 추가에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            app.loadSchedule(app.year, app.month);
                        });
                    }
                    ,
                    untag(scheduleId, friendId) {
                        if (!isMyCalendar) {
                            return;
                        }
                        fetch(`/api/schedules/${scheduleId}/tags/${friendId}`, {
                            method: 'DELETE',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '태그 제거에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            app.loadSchedule(app.year, app.month);
                        });
                    }
                    ,
                    untagSelf(schedule) {
                        if (!isMyCalendar) {
                            return;
                        }
                        const scheduleId = schedule.id;
                        const scheduleElement = document.getElementById('schedule-' + scheduleId);
                        const scheduleBy = scheduleElement.querySelector('.schedule-tags').querySelector('.schedule-tag').innerText;

                        Swal.fire({
                            title: '정말로 태그를 제거하시겠습니까?',
                            html: `태그된 아래의 일정을 제거합니다.<br/>[${schedule.content}] by${scheduleBy}<br/> 태그를 다시 복구하려면 해당 사용자에게 요청해야합니다.`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#999',
                            confirmButtonText: '제거',
                            cancelButtonText: '취소',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                fetch(`/api/schedules/${scheduleId}/tags`, {
                                    method: 'DELETE',
                                }).then(response => {
                                    if (!response.ok) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: '태그 제거에 실패했습니다.',
                                            showConfirmButton: false,
                                            timer: sweetAlTimer
                                        });
                                        return;
                                    }
                                    app.loadSchedule(app.year, app.month);
                                });
                            }
                        });
                    }
                    ,
                    addTodoModal() {
                        const modal = document.getElementById('add-todo-modal');
                        modal.querySelector('.todo-title').value = '';
                        modal.querySelector('.todo-content').value = '';
                        $('#add-todo-modal').modal('show');
                    },
                    addTodo() {
                        const addTodoModal = document.getElementById('add-todo-modal');
                        const title = addTodoModal.querySelector('.todo-title').value;
                        const content = addTodoModal.querySelector('.todo-content').value;
                        if (!title) {
                            app.alertTodoTitle();
                            return;
                        }

                        fetch('/api/todos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: title,
                                content: content,
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 추가에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 추가되었습니다.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            app.loadTodos();
                            $('#add-todo-modal').modal('hide');
                        });

                    }, showTodoDetails(todo) {
                        const modal = document.getElementById("todo-details-modal");
                        modal.querySelector(".todo-title").value = todo.title;
                        modal.querySelector(".todo-content").value = todo.content;
                        modal.querySelector(".todo-date").textContent = todo.createdDate;
                        $('#todo-details-modal').modal('show');

                        modal.setAttribute('data-id', todo.id);
                        app.editTodoMode = false;
                    },
                    deleteTodo() {
                        const modal = document.getElementById("todo-details-modal");
                        const todoId = modal.getAttribute('data-id');

                        fetch(`/api/todos/${todoId}`, {
                            method: 'DELETE',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 삭제에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 삭제되었습니다.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            app.loadTodos();
                            $('#todo-details-modal').modal('hide');
                        });
                    },
                    initSortable() {
                        let todoListElement = document.getElementById('todo-list');
                        if (todoListElement) {
                            const sortable = new Sortable(todoListElement, {
                                animation: 150,
                                draggable: ".todo-item",
                                handle: '.handle',
                                onEnd: (evt) => {
                                    app.updatePosition();
                                },
                            });
                        }
                    },
                    loadTodos() {
                        fetch('/api/todos')
                            .then(response => {
                                if (!response.ok) {
                                    Swal.fire({
                                        icon: 'error',
                                        title: '할 일 목록을 불러오는데 실패했습니다.',
                                        showConfirmButton: false,
                                        timer: sweetAlTimer
                                    });
                                    return;
                                }
                                return response.json();
                            }).then(data => {
                            this.todos = data;
                        });
                    },
                    updatePosition() {
                        const todoListElement = document.getElementById('todo-list');
                        const todoItems = todoListElement.querySelectorAll('.todo-item');
                        const todoIds = Array.from(todoItems).map(todo => todo.getAttribute('data-id'));
                        fetch('/api/todos/position', {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(todoIds)
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 순서 변경에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                        });
                    },
                    updateTodo() {
                        const modal = document.getElementById("todo-details-modal");
                        const todoId = modal.getAttribute('data-id');
                        const title = modal.querySelector('.todo-title').value;
                        const content = modal.querySelector('.todo-content').value;

                        if (!title) {
                            app.alertTodoTitle();
                            return;
                        }

                        fetch(`/api/todos/${todoId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: title,
                                content: content,
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 수정에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 수정되었습니다.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            app.loadTodos();
                            $('#todo-details-modal').modal('hide');
                        });
                    },
                    showBatchUpdate() {
                        Swal.fire({
                            title: '한번에 수정',
                            html: `
                              <p>${app.year}년 ${app.month}월의 기본 듀티를 선택해주세요.</p>
                              <p>현재 월의 모든 날짜가 선택한 듀티로 설정됩니다.</p>
                              <p class="bg-warning">클릭시 바로 변경됩니다.</p>
                              <div>
                                  ${app.department.dutyTypes.map(type => `
                                      <button class="btn duty-type BACKGROUND-${type.color}" data-id="${type.id}">
                                          ${type.name}
                                      </button>
                                  `).join('')}
                              </div>`,
                            showConfirmButton: false,
                            showCancelButton: true,
                            cancelButtonText: '취소',
                            didOpen: () => {
                                const buttons = document.querySelectorAll('.swal2-html-container button');
                                buttons.forEach(button => {
                                    button.addEventListener('click', () => {
                                        const dutyId = button.getAttribute('data-id');
                                        this.batchUpdate(dutyId);
                                        Swal.close();
                                    });
                                });
                            }
                        });
                    },
                    batchUpdate(dutyTypeId) {
                        fetch(`/api/duty/batch`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                year: app.year,
                                month: app.month,
                                dutyTypeId: dutyTypeId,
                                memberId: memberId,
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '일괄 수정에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            app.loadDuties(app.year, app.month);
                        });
                    },
                    async uploadBatchFile() {
                        const fileExtensions = app.department.dutyBatchTemplate.fileExtensions;
                        const {value: file} = await Swal.fire({
                            title: "시간표 파일 업로드",
                            input: "file",
                            html: "시간표 파일을 업로드해주세요.<br/> 자동으로 파일에 맞춰 시간표를 업데이트 합니다.<br/>파일을 선택하기 전에, 업로드하는 시간표가 현재 선택된 년월에 맞는지 꼭 확인해주세요.",
                            inputAttributes: {
                                "accept": fileExtensions.join(','),
                                "aria-label": "시간표 파일을 업로드해주세요.",
                            },
                            confirmButtonText: "등록",
                        });
                        if (!file)
                            return;
                        const formData = new FormData();
                        formData.append("file", file);
                        formData.append("year", app.year);
                        formData.append("month", app.month);
                        formData.append("memberId", memberId);
                        fetch("/api/duty_batch", {
                            method: "POST",
                            body: formData,
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: "error",
                                    title: "파일 업로드에 실패했습니다.",
                                    showConfirmButton: false,
                                    timer: sweetAlTimer
                                });
                                return;
                            }
                            return response.json()
                        }).then(data => {
                            if (!data.result) {
                                Swal.fire({
                                    icon: "error",
                                    title: "시간표 파일 업로드 실패",
                                    text: data.errorMessage,
                                });
                                return;
                            }
                            const workingDays = data.workingDays;
                            const offDays = data.offDays;
                            const startDate = data.startDate;
                            const endDate = data.endDate;
                            swal.fire({
                                icon: "success",
                                title: "시간표 적용 완료",
                                html: `시간표가 업로드 되었습니다.<br/>[${startDate}] ~ [${endDate}]<br/> 총 ${workingDays + offDays}일 중 근무일은 ${workingDays}, 휴무일은 ${offDays}일 입니다.`,
                                confirmButtonText: "확인",
                            });
                            app.loadDuties(app.year, app.month);
                        });
                    },
                    search(page = 0) {
                        $('#search-result-modal').modal('show');
                        const query = app.searchQuery;
                        fetch(`/api/schedules/${memberId}/search?q=${query}&page=${page}`)
                            .then((response) => {
                                if (!response.ok) {
                                    Swal.fire({
                                        icon: 'error',
                                        title: '검색에 실패했습니다.',
                                        showConfirmButton: false,
                                        timer: sweetAlTimer
                                    });
                                    return;
                                }
                                return response.json();
                            })
                            .then((data) => {
                                app.searchResults = data;
                            });
                    },
                    moveToSearch(item) {
                        const startDateTime = new Date(item.startDateTime);
                        app.year = startDateTime.getFullYear();
                        app.month = startDateTime.getMonth() + 1;
                        app.searchDay = startDateTime.getDate();
                        $('#search-result-modal').modal('hide');
                    },
                    isValidContent(content) {
                        if (!content) {
                            Swal.fire({
                                icon: 'error',
                                title: '내용을 입력해주세요.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            return false;
                        }
                        if (content.length > app.schedule_content_max_length) {
                            Swal.fire({
                                icon: 'error',
                                title: app.schedule_content_max_length + '자 이내로 입력해주세요.',
                                showConfirmButton: false,
                                timer: sweetAlTimer
                            });
                            return false;
                        }
                        return true;
                    },
                    alertTodoTitle() {
                        Swal.fire({
                            icon: 'error',
                            title: '할일 제목을 입력해주세요.',
                            showConfirmButton: false,
                            timer: sweetAlTimer
                        });
                    },
                    sameDateTime(startDateTime, endDateTime) {
                        return startDateTime.getTime() === endDateTime.getTime();
                    },
                    isValidDateTime(startDateTime, endDateTime) {
                        if (!startDateTime || !endDateTime) {
                            Swal.fire({
                                icon: 'error',
                                title: '시작일시와 종료일시를 모두 입력해주세요.',
                                confirmButtonText: '확인',
                            });
                            return false;
                        }
                        if (new Date(startDateTime) > new Date(endDateTime)) {
                            Swal.fire({
                                icon: 'error',
                                title: '종료일시는 시작일시보다 빠를 수 없습니다.',
                                confirmButtonText: '확인',
                            });
                            return false;
                        }
                        return true;
                    }
                }
            }
        )
    })

</script>
