<div th:unless="${visible}">
  <div class="alert alert-danger" role="alert">
    <p></p><span th:text="${member.name}"></span> 님의 시간표를 조회할 수 없습니다.</p>
    <p>해당 시간표는 <span class="text-bg-warning" th:text="${member.calendarVisibility.label}"></span> 상태입니다.</p>
  </div>
</div>
<div class="duty-vue" v-cloak th:if="${visible}">
  <div class="todo-container" v-if="isMyCalendar">
    <div class="d-flex">
      <div id="add-todo-btn" v-on:click="addTodoModal()">
        <span>할일 +</span>
      </div>
      <div class="d-flex flex-row" id="todo-list-container">
        <div class="d-flex flex-row" id="todo-list">
          <div v-for="todo in todos" class="todo-item" :data-id="todo.id">
            <div class="handle">
              <i class="bi bi-list"></i>
            </div>
            <strong class="todo-text" v-text="todo.title" v-on:click="showTodoDetails(todo)"></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div th:if="${member.department}" class="calendar" th:attr="data-member_id=${member.id}">
    <div class="month-control row">
      <div class="month-control-left col-md-2">
        <div class="info department-info">
          <i class="bi bi-people-fill"></i>
          <span th:text="${member.department}"></span>
        </div>
      </div>
      <div class="col-md-8">
        <h1>
          <button class="btn today-button" v-on:click="today()">오늘</button>
          <a class="move h_pointer" v-on:click="addMonth(-1)">
            <i class="bi bi-arrow-left-circle"></i>
          </a>
          <input id="month-selector" type="month" v-model="combinedYearMonth">
          <a class="move h_pointer" v-on:click="addMonth(1)">
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </h1>
      </div>
      <div class="month-control-right col-md-2">
        <div class="info member-info">
          <span th:text="${member.name}"></span>
          <i class="bi bi-person-badge"></i>
        </div>
      </div>
    </div>
    <div class="dutyTypes">
    <span v-for="type in department.dutyTypes">
      <span :class="['indicator', 'BACKGROUND-' + type.color]">&nbsp;&nbsp;&nbsp;</span>
      <span v-text="type.name"></span>
    </span>
      <button v-if="isMyCalendar"
              class="btn btn-warning"
              v-on:click="privacyPopup()"
              v-text="'공개대상:' + privacyLabel"
      >
      </button>
      <button v-if="canEdit && !batchEditMode"
              class="edit-btn btn btn-info"
              v-on:click="batchEditMode=true;">편집모드
      </button>
      <button v-if="canEdit && batchEditMode"
              class="edit-btn btn btn-success"
              v-on:click="batchEditMode=false;">편집완료
      </button>
    </div>
    <div class="day-of-the-week row-7">
      <div><abbr title="일요일">SUN</abbr></div>
      <div><abbr title="월요일">MON</abbr></div>
      <div><abbr title="화요일">TUE</abbr></div>
      <div><abbr title="수요일">WED</abbr></div>
      <div><abbr title="목요일">THU</abbr></div>
      <div><abbr title="금요일">FRI</abbr></div>
      <div><abbr title="토요일">SAT</abbr></div>
    </div>

    <div class="day-grid row-7" :class="{'editable': canEdit}">
      <div class="DAY"
           :id="formattedDate(duty.year, duty.month, duty.day)"
           v-for="(duty, index) in duties"
           :class="{
          ['BACKGROUND-' + duty.dutyColor]: true,
          'month-prev': (duty.month < month),
          'month-next': (duty.month > month),
          'today': isToday(duty),
          'holiday': isHoliday(index),
          'has-schedule': hasSchedule(index),
        }"
           v-on:click="viewDayDetail(duty, index)">
        <div class="date container">
          <div class="row day-header">
            <div class="col-md-5">
              <div class="day">
                <span v-text="duty.day"></span>
              </div>
            </div>
            <div class="col-md-7">
              <span v-if="selectedDday" v-text="calcDday(duty)" class="d-day-count"></span>
            </div>
          </div>
          <div v-if="!batchEditMode" class="schedules">
            <div v-if="holidaysByDays[index]"
                 class="holiday-info"
                 v-for="holiday in holidaysByDays[index]">
                            <span :class="holiday.isHoliday ? 'holiday' : 'not-holiday'"
                                  v-text="holiday.dateName">

                            </span>
            </div>
            <div class="d-day-schedules"></div>
            <div class="schedule" v-for="schedule in schedulesByDays[index]" v-html="printSchedule(schedule)">
            </div>
          </div>
          <div v-if="batchEditMode" class="duty row">
            <button v-for="type in department.dutyTypes"
                    class="duty-type btn btn-sm btn-outline-dark"
                    v-text="type.name.length > 3 ? type.name.substring(0, 3) : type.name"
                    :class="dutyTypeClasses(type, duty)"
                    :disabled="(duty.dutyType == type.name) || (!duty.dutyType && !type.id)"
                    v-on:click="changeDutyType(duty, type)"
            >
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="d-day-list row">
      <div v-for="(dDay, index) in dDays" class="col-6">
        <div class="d-day-item card row shadow"
             v-on:click="dDayToggle(dDay)"
             :data-id="dDay.id"
             :class="{'d-day-private': dDay.isPrivate, 'selected': dDay == selectedDday}"
        >
          <div class="d-day_day col-4">
            <span v-if="!dDay.editMode">{{dDay.dDayText}}</span>
          </div>
          <div class="d-day_content col-8">
            <p v-if="!dDay.editMode">{{dDay.date}}</p>
            <p v-if="!dDay.editMode">{{dDay.title}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div th:if="!${member.department}" class="no-department p-5">
    <h3>어느 부서에도 소속되어 있지 않습니다.</h3>
  </div>

  <div id="privacy-config-modal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">시간표 공개 대상 설정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>내 시간표를 공개할 범위를 설정하세요</p>
          <div class="privacy-config btn-group" role="group" aria-label="Privacy setting">
            <button type="button" class="btn btn-success" :class="{'selected': calendarVisibility=='PUBLIC'}"
                    data-privacy="PUBLIC" v-on:click="setPrivacy">누구나
            </button>
            <button type="button" class="btn btn-warning" :class="{'selected': calendarVisibility=='FRIENDS'}"
                    data-privacy="FRIENDS" v-on:click="setPrivacy">친구만
            </button>
            <button type="button" class="btn btn-danger" :class="{'selected': calendarVisibility=='PRIVATE'}"
                    data-privacy="PRIVATE" v-on:click="setPrivacy">비공개
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <div id="todo-details-modal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="todo-details-title">할일 상세</h5>
        </div>
        <div class="modal-body">
          <div class="modal-body">
            <div class="input-group mb-2">
              <span class="input-group-text" id="todo-title-input">제목</span>
              <input type="text" class="todo-title form-control" aria-labelledby="todo-title-input"
                     aria-label="title" :readonly="!editTodoMode"/>
            </div>
            <div class="input-group">
              <span class="input-group-text" id="todo-content-input">내용</span>
              <textarea class="todo-content form-control" aria-label="content" aria-labelledby="todo-content-input"
                        :readonly="!editTodoMode"></textarea>
            </div>
          </div>
          <div class="text-right">
            <p class="text-muted todo-date"></p>
            <button type="button" class="btn btn-info btn-sm" v-on:click="editTodoMode=true" v-if="!editTodoMode">수정
            </button>
            <button type="button" class="btn btn-success btn-sm" v-on:click="updateTodo()" v-if="editTodoMode">저장
            </button>
            <button type="button" class="btn btn-danger btn-sm" v-on:click="deleteTodo()">삭제</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
      class="modal fade"
      id="add-todo-modal"
      tabindex="-1"
      aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">할일 추가</h5>
        </div>
        <div class="modal-body">
          <input
              type="text"
              class="form-control todo-title"
              name="title"
              placeholder="할일 제목"
          />
          <textarea
              class="form-control todo-content"
              name="content"
              rows="4"
              placeholder="할일 상세내용"
          ></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" v-on:click="addTodo()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-view-modal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" v-if="detailView">
        <div class="modal-header">
          <p class="current-date-label"
             v-text="detailView?.year + '년 ' + detailView?.month + '월 ' + detailView?.day + '일'"></p>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="dutyTypes">
            <form>
              <div v-for="type in department.dutyTypes" class="pretty p-round p-pulse">
                <input type="radio" name="dutyType"
                       :checked="isDutyType(detailView, type)"
                       v-on:click="changeDutyType(detailView, type)"
                />
                <div class="state p-primary">
                  <label v-text="type.name"></label>
                </div>
              </div>
            </form>
          </div>
          <div class="schedules mt-4">
            <div class="schedule card shadow"
                 v-if="!isCreateScheduleMode && (editingSchedule.id == null || isEditing(schedule) )"
                 :class="{'visibility-public': schedule.visibility == 'PUBLIC', 'visibility-friends': schedule.visibility == 'FRIENDS', 'visibility-private': schedule.visibility == 'PRIVATE'}"
                 v-for="(schedule, s_index) in schedulesByDays[detailView.index]"
                 :id="'schedule-' + schedule.id">
              <span v-if="!isEditing(schedule)" v-html="printSchedule(schedule)"></span>
              <div v-if="isEditing(schedule)" class="schedule-edit">
                <label>일정 추가 <span class="content-length"
                                   v-text="editingSchedule.content.length + ' / 50'"></span></label>
                <textarea class="form-control" placeholder="일정을 입력하세요." maxlength="50" rows="3"
                          v-model="editingSchedule.content"></textarea>
                <label>시작일</label>
                <input type="datetime-local" class="form-control"
                       v-model="editingSchedule.startDateTime"/>
                <label>종료일</label>
                <input type="datetime-local" class="form-control"
                       v-model="editingSchedule.endDateTime"/>
                <label>공개설정</label>
                <div class="schedule-visibility">
                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PUBLIC" v-model="editingSchedule.visibility"/>
                    <div class="state p-success-o">
                      <label>전체공개</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FRIENDS" v-model="editingSchedule.visibility"/>
                    <div class="state p-warning-o">
                      <label>친구공개</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PRIVATE" v-model="editingSchedule.visibility"/>
                    <div class="state p-danger-o">
                      <label>비공개</label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="buttons mt-3" v-if="!isEditing(schedule)">
                <template v-if="schedule.isTagged">
                  <button class="btn btn-danger" v-on:click="untagSelf(schedule)">태그제거</button>
                </template>
                <template v-else>
                  <template
                      v-if="schedulesByDays[detailView.index].length > detailView.scheduleStartDiffCount + 1 && dutyAndDateTimeSame(detailView, schedule.startDateTime)">
                    <button
                        :disabled="s_index == schedulesByDays[detailView.index].length -1 || schedulesByDays[detailView.index][s_index+1].isTagged"
                        v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index+1])"
                        class="btn btn-secondary"
                    >
                      <i class="bi bi-arrow-down-square"></i>
                    </button>
                    <button :disabled="s_index <= detailView.scheduleStartDiffCount"
                            v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index-1])"
                            class="btn btn-secondary">
                      <i class="bi bi-arrow-up-square"></i>
                    </button>
                  </template>
                  <button class="btn btn-info" v-on:click="scheduleEditMode(schedule)">수정</button>
                  <button class="btn btn-danger" v-on:click="deleteSchedule(schedule)">삭제</button>
                </template>
              </div>
              <div class="buttons mt-3" v-if="isEditing(schedule)">
                <button class="btn btn-success" v-on:click="editSchedule()">저장</button>
                <button class="btn btn-secondary" v-on:click="cancelEditMode()">취소</button>
              </div>
            </div>
            <div class="schedule schedule-add-button card shadow"
                 v-if="!isCreateScheduleMode && !editingSchedule.id">
              <button class="btn btn-success" v-on:click="scheduleCreateMode()">일정 추가</button>
            </div>
            <div class="schedule schedule-add card shadow" v-if="isCreateScheduleMode">
              <label>일정 추가 <span class="content-length"
                                 v-text="createSchedule.content.length + ' / 50'"></span></label>
              <textarea class="form-control" placeholder="일정을 입력하세요." maxlength="50" rows="3"
                        v-model="createSchedule.content"></textarea>
              <label>시작일</label>
              <input type="datetime-local" class="form-control"
                     v-model="createSchedule.startDateTime"/>
              <label>종료일</label>
              <input type="datetime-local" class="form-control" v-model="createSchedule.endDateTime"
                     :min="createSchedule.startDateTime"/>
              <label>공개설정</label>
              <div class="schedule-visibility">
                <div class="pretty p-default p-curve">
                  <input type="radio" value="PUBLIC" v-model="createSchedule.visibility"/>
                  <div class="state p-success-o">
                    <label>전체공개</label>
                  </div>
                </div>

                <div class="pretty p-default p-curve">
                  <input type="radio" value="FRIENDS" v-model="createSchedule.visibility"/>
                  <div class="state p-warning-o">
                    <label>친구공개</label>
                  </div>
                </div>

                <div class="pretty p-default p-curve">
                  <input type="radio" value="PRIVATE" v-model="createSchedule.visibility"/>
                  <div class="state p-danger-o">
                    <label>비공개</label>
                  </div>
                </div>
              </div>
              <div class="buttons mt-3">
                <button id="add-btn" class="btn btn-success" v-on:click="saveSchedule">추가</button>
                <button class="btn btn-secondary" v-on:click="cancelCreateSchedule">취소</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>

</div>

<script>
    $(function () {
        const memberId = parseInt("[[${member.id}]]");
        const departmentId = parseInt("[[${member.departmentId}]]");
        const loginMemberId = parseInt("[[${loginMember?.id}]]");
        const managerId = parseInt("[[${member.managerId}]]");

        const app = new Vue({
                el: '.duty-vue',
                data: {
                    year: parseInt("[[${year}]]"),
                    month: parseInt("[[${month}]]"),
                    duties: [],
                    schedulesByDays: [],
                    holidaysByDays: [],
                    department: {},
                    dDays: [],
                    selectedDday: null,
                    detailView: null,
                    batchEditMode: false,
                    isCreateScheduleMode: false,
                    calendarVisibility: "[[${member.calendarVisibility}]]",
                    createSchedule: {
                        content: '',
                        startDateTime: '',
                        startDateTimeOld: '',
                        endDateTime: '',
                        visibility: 'FRIENDS',
                    },
                    editingSchedule: {
                        id: '',
                        content: '',
                        startDateTime: '',
                        startDateTimeOld: '',
                        endDateTime: '',
                        visibility: '',
                    },
                    friends: [],
                    todos: [],
                    editTodoMode: false,
                }, mounted() {
                    if (departmentId) {
                        this.loadDepartment();
                        this.loadDuties(this.year, this.month);
                    }
                    this.loadSchedule(this.year, this.month);
                    this.loadHolidays(this.year, this.month);
                    this.loadFriends();
                    this.loadDDays();
                    this.loadTodos();

                    document.addEventListener('click', function (event) {
                        if (event.target && event.target.matches('.schedule-tag-add')) {
                            event.target.querySelector('select').focus();
                        }
                    });

                    document.addEventListener('change', function (event) {
                        if (event.target && event.target.matches('.schedule-tag-add select')) {
                            const selectedOption = event.target.options[event.target.selectedIndex];
                            const scheduleId = event.target.closest('.schedule').id.replace('schedule-', '');
                            const friendId = selectedOption.getAttribute('data-id');
                            app.addTag(scheduleId, friendId);
                        }
                    });
                    document.addEventListener('click', function (event) {
                        if (event.target && event.target.matches('#detail-view-modal .schedule-tag.tagged-false')) {
                            const scheduleId = event.target.closest('.schedule').id.replace('schedule-', '');
                            const friendId = event.target.getAttribute('data-id');
                            app.untag(scheduleId, friendId);
                        }
                    });
                    this.initSortable();
                }, computed: {
                    combinedYearMonth: {
                        get() {
                            return `${this.year}-${this.month.toString().padStart(2, '0')}`;
                        },
                        set(value) {
                            if (!value) {
                                value = new Date().toISOString().slice(0, 7);
                                document.getElementById('month-selector').value = value;
                            }
                            const [year, month] = value.split('-');
                            this.year = parseInt(year);
                            this.month = parseInt(month);
                        },
                    },
                    canEdit() {
                        return loginMemberId === memberId || loginMemberId === managerId;
                    },
                    isMyCalendar() {
                        return loginMemberId === memberId;
                    },
                    calcDday() {
                        return (duty) => {
                            const date = new Date(duty.year, duty.month - 1, duty.day);
                            const calc = Math.floor((date.getTime() - new Date(app.selectedDday.date).getTime()) / (1000 * 60 * 60 * 24)) + 1;
                            const dDayText = calc < 0 ? 'D' + calc : calc == 0 ? 'D-Day' : 'D+' + (calc + 1);
                            return dDayText;
                        }
                    },
                    printSchedule() {
                        return (schedule) => {
                            let content = schedule.content.replace(/\n/g, '<br>');
                            if (schedule.totalDays > 1) {
                                content += '[' + schedule.daysFromStart + '/' + schedule.totalDays + '] ';
                            }
                            const tags = []
                            schedule.tags.forEach(tag => {
                                if (tag.id !== memberId) {
                                    tags.push({
                                        name: tag.name,
                                        id: tag.id,
                                    });
                                }
                            });
                            if (schedule.isTagged) {
                                tags.push({name: schedule.owner});
                            }
                            let scheduleElement = `<p class="schedule-content" >${content}<small>${app.printScheduleTime(schedule)}</small></p>`;
                            let tagElements = ''
                            if (tags.length > 0) {
                                tagElements += tags.map(tag => {
                                    return `<span class="schedule-tag tagged-${schedule.isTagged}" data-id="${tag.id}" >${tag.name} </span>`;
                                }).join('');
                            }
                            if (!schedule.isTagged && app.friends.length > 0) {
                                let tagFriendAria = `
                                      <span class="schedule-tag schedule-tag-add">
                                        <select>
                                        <option>태그</option>
                                        ${app.friends.map(friend => {
                                    if (tags.find(tag => tag.id === friend.id)) {
                                        return '';
                                    }
                                    return `<option data-id="${friend.id}">[${friend.department}] ${friend.name}</option>`;
                                }).join('')}
                                      </select>
                                      </span>`;
                                tagElements += tagFriendAria;
                            }
                            return scheduleElement + `<div class="schedule-tags">${tagElements}</div>`;
                        }
                    },
                    printScheduleTime() {
                        return (schedule) => {
                            let result = '';
                            if (app.shouldDisplayStartTime(schedule)) {
                                const startTime = app.formattedTime(schedule.startDateTime);
                                result += '(' + startTime;
                                if (app.shouldDisplayEndTime(schedule)) {
                                    const endTime = app.formattedTime(schedule.endDateTime);
                                    return result + '~' + endTime + ')';
                                }
                                return result + ')';
                            }

                            if (app.shouldDisplayEndTime(schedule)) {
                                const endTime = app.formattedTime(schedule.endDateTime);
                                return result + ' (~' + endTime + ')';
                            }
                            return result;
                        }
                    }
                    ,
                    shouldDisplayStartTime() {
                        return (schedule) => {
                            const daysFromStart = schedule.daysFromStart;
                            const startDateTime = new Date(schedule.startDateTime);
                            const startHour = startDateTime.getHours().toString().padStart(2, '0');
                            const startMinute = startDateTime.getMinutes().toString().padStart(2, '0');
                            return daysFromStart === 1 && !(startHour === '00' && startMinute === '00');
                        }
                    }
                    ,
                    shouldDisplayEndTime() {
                        return (schedule) => {
                            const daysFromStart = schedule.daysFromStart;
                            const totalDays = schedule.totalDays;
                            const startDateTime = new Date(schedule.startDateTime);
                            const endDateTime = new Date(schedule.endDateTime);
                            const endHour = endDateTime.getHours().toString().padStart(2, '0');
                            const endMinute = endDateTime.getMinutes().toString().padStart(2, '0');
                            return (daysFromStart === totalDays)
                                && !(endHour === '00' && endMinute === '00')
                                && !(totalDays === 1 && sameDateTime(startDateTime, endDateTime));
                        }
                    }
                    ,
                    dutyAndDateTimeSame() {
                        return (duty, dateTimeString) => {
                            const year = duty.year;
                            const month = duty.month - 1;
                            const day = duty.day;
                            const dateTime = new Date(dateTimeString);
                            return year === dateTime.getFullYear() && month === dateTime.getMonth() && day === dateTime.getDate();
                        }
                    }
                    ,
                    hasSchedule() {
                        return (index) => {
                            return this.schedulesByDays[index] && this.schedulesByDays[index].length > 0;
                        }
                    },
                    privacyLabel() {
                        return {
                            PUBLIC: '누구나',
                            FRIENDS: '친구만',
                            PRIVATE: '비공개',
                        }[this.calendarVisibility];
                    }
                },
                watch: {
                    combinedYearMonth() {
                        this.loadDuties(app.year, app.month);
                        this.loadSchedule(app.year, app.month);
                        this.loadHolidays(app.year, app.month);
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('year', app.year);
                        currentUrl.searchParams.set('month', app.month);
                        window.history.replaceState(null, '', currentUrl.toString());
                    }
                    ,
                    'createSchedule.startDateTime':
                        function () {
                            if (app.createSchedule.startDateTimeOld === app.createSchedule.endDateTime || app.createSchedule.startDateTime > app.createSchedule.endDateTime) {
                                app.createSchedule.endDateTime = app.createSchedule.startDateTime;
                            }
                            app.createSchedule.startDateTimeOld = app.createSchedule.startDateTime;
                        }
                    ,
                    'editingSchedule.startDateTime':
                        function () {
                            if (app.editingSchedule.startDateTimeOld === app.editingSchedule.endDateTime || app.editingSchedule.startDateTime > app.editingSchedule.endDateTime) {
                                app.editingSchedule.endDateTime = app.editingSchedule.startDateTime;
                            }
                            app.editingSchedule.startDateTimeOld = app.editingSchedule.startDateTime;
                        }
                    ,
                },
                methods: {
                    addMonth(month) {
                        const newDate = new Date(app.year, app.month - 1 + month);
                        app.year = newDate.getFullYear();
                        app.month = newDate.getMonth() + 1;
                    }
                    ,
                    today() {
                        const today = new Date();
                        app.year = today.getFullYear();
                        app.month = today.getMonth() + 1;
                    }
                    ,
                    loadDuties(year, month) {
                        $.ajax({
                            url: '/api/duty',
                            type: 'GET',
                            data: {
                                memberId: memberId,
                                year: year,
                                month: month,
                            },
                            success: (data) => {
                                this.duties = data;
                                // wait for rendering then check d-day
                                setTimeout(() => {
                                    this.checkDDays();
                                });
                            }
                        })
                    }
                    ,
                    loadDDays() {
                        $.ajax({
                            url: '/api/dday/' + memberId,
                            type: 'GET',
                            success: (data) => {
                                this.dDays = data;
                                const selectedDdayId = parseInt(localStorage.getItem('selectedDday_' + memberId));
                                for (const dDay of app.dDays) {
                                    if (dDay.id === selectedDdayId) {
                                        app.selectedDday = dDay;
                                    }
                                    if (dDay.calc === 0) {
                                        dDay.dDayText = 'D-Day';
                                    } else if (dDay.calc < 0) {
                                        dDay.dDayText = 'D+' + -dDay.calc;
                                    } else {
                                        dDay.dDayText = 'D-' + dDay.calc;
                                    }
                                }
                            }
                        })
                    }
                    ,
                    checkDDays() {
                        $('.d-day-schedules').html('');
                        for (const dDay of app.dDays) {
                            const dayElement = document.getElementById(dDay.date);
                            if (dayElement) {
                                let scheduleElement = document.createElement('div');
                                scheduleElement.classList.add('schedule', 'd-day-schedule');
                                scheduleElement.innerHTML = '[D-Day] ' + dDay.title;
                                dayElement.querySelector('.d-day-schedules').prepend(scheduleElement);
                            }
                        }
                    }
                    ,
                    dDayToggle(dDay) {
                        if (app.selectedDday == dDay) {
                            app.selectedDday = null;
                            localStorage.removeItem('selectedDday_' + memberId);
                        } else {
                            app.selectedDday = dDay;
                            localStorage.setItem('selectedDday_' + memberId, dDay.id);
                        }
                    }
                    ,
                    loadSchedule(year, month) {
                        $.ajax({
                            url: '/api/schedules',
                            type: 'GET',
                            data: {
                                memberId: memberId,
                                year: year,
                                month: month,
                            },
                            success: (data) => {
                                this.schedulesByDays = data;
                            }
                        })
                    }
                    ,
                    loadDepartment() {
                        fetch(`/api/departments/${departmentId}`)
                            .then(response => response.json())
                            .then(data => {
                                this.department = data;
                            })
                    }
                    ,
                    editDuty() {
                        const memberId = document.getElementsByClassName('calendar')[0].getAttribute('data-member_id');
                        window.location.href = `/duty/edit?memberId=${memberId}&year=${(app.year)}&month=${(app.month)}`;
                    }
                    ,
                    formattedTime(timeString) {
                        const dateTime = new Date(timeString);
                        const hour = dateTime.getHours() == 12 ? 12 : dateTime.getHours() % 12;
                        let minute = '';
                        if (dateTime.getMinutes() != 0) {
                            minute = ':' + dateTime.getMinutes().toString().padStart(2, '0');
                        }
                        return hour + minute + (dateTime.getHours() >= 12 ? 'PM ' : 'AM');
                    }
                    ,
                    formattedDate(year, month, day) {
                        month = (month < 10) ? '0' + month : month;
                        day = (day < 10) ? '0' + day : day;
                        return year + '-' + month + '-' + day;
                    }
                    ,
                    isToday(duty) {
                        const today = new Date();
                        return duty.year === today.getFullYear() && duty.month === today.getMonth() + 1 && duty.day === today.getDate();
                    }
                    ,
                    isHoliday(index) {
                        const holidays = app.holidaysByDays[index];
                        if (!holidays || holidays.length === 0) {
                            return false;
                        }
                        for (const holiday of holidays) {
                            if (holiday.isHoliday)
                                return true;
                        }
                        return false;
                    }
                    ,
                    viewDayDetail(duty, index) {
                        if (app.batchEditMode || !app.canEdit) {
                            return;
                        }
                        app.isCreateScheduleMode = false;
                        $('#detail-view-modal').modal('show');
                        app.detailView = duty;
                        app.detailView.index = index;
                        app.detailView.scheduleStartDiffCount = app.schedulesByDays[index].length;
                        for (const schedule of app.schedulesByDays[index]) {
                            if (app.dutyAndDateTimeSame(duty, schedule.startDateTime)) {
                                app.detailView.scheduleStartDiffCount--;
                            }
                        }
                        app.resetCreateSchedule();
                        app.cancelEditMode();
                    }
                    ,
                    resetCreateSchedule() {
                        app.createSchedule = {
                            content: '',
                            startDateTime: app.formattedDateTime(app.detailView),
                            endDateTime: app.formattedDateTime(app.detailView),
                            visibility: 'FRIENDS',
                        }
                    }
                    ,
                    isDutyType(duty, dutyType) {
                        if (duty?.dutyType) {
                            return dutyType.name == duty.dutyType
                        }
                        return !dutyType.id
                    }
                    ,
                    changeDutyType(duty, type) {
                        $.ajax({
                            url: '/api/duty/change',
                            type: 'PUT',
                            data: JSON.stringify({
                                year: duty.year,
                                month: duty.month,
                                day: duty.day,
                                dutyTypeId: type.id,
                                memberId: memberId,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                duty.dutyType = type.name;
                                duty.dutyColor = type.color;
                            },
                            fail: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }
                        })
                    }
                    ,
                    formattedDateTime(duty) {
                        const month = duty.month.toString().padStart(2, '0');
                        const day = duty.day.toString().padStart(2, '0');
                        return `${duty.year}-${month}-${day}T00:00`;
                    }
                    ,
                    scheduleCreateMode() {
                        app.isCreateScheduleMode = true;
                        const schedules = document.querySelector('#detail-view-modal .schedules');
                    },
                    cancelCreateSchedule() {
                        app.isCreateScheduleMode = false;
                        app.resetCreateSchedule();
                    }
                    ,
                    saveSchedule() {
                        if (!isValidContent(app.createSchedule.content)) {
                            return;
                        }
                        if (!isValidDateTime(app.createSchedule.startDateTime, app.createSchedule.endDateTime)) {
                            return;
                        }
                        const addArea = $('.schedule-add');
                        addArea.waitMe();
                        $.ajax({
                            url: '/api/schedules',
                            type: 'POST',
                            data: JSON.stringify({
                                memberId: memberId,
                                content: app.createSchedule.content,
                                startDateTime: toLocalISOString(new Date(app.createSchedule.startDateTime)),
                                endDateTime: toLocalISOString(new Date(app.createSchedule.endDateTime)),
                                visibility: app.createSchedule.visibility,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                // SAVED
                                app.resetCreateSchedule();
                                app.loadSchedule(app.year, app.month);
                                app.isCreateScheduleMode = false;
                            },
                            error: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }, complete: () => {
                                addArea.waitMe('hide');
                            }
                        })
                    }
                    ,
                    scheduleEditMode(schedule) {
                        app.cancelCreateSchedule();
                        app.editingSchedule.id = schedule.id;
                        app.editingSchedule.content = schedule.content;
                        app.editingSchedule.startDateTime = schedule.startDateTime;
                        app.editingSchedule.endDateTime = schedule.endDateTime;
                        app.editingSchedule.visibility = schedule.visibility;
                    }
                    ,
                    cancelEditMode() {
                        app.editingSchedule.id = null;
                        app.editingSchedule.content = '';
                        app.editingSchedule.startDateTime = '';
                        app.editingSchedule.endDateTime = '';
                    }
                    ,
                    isEditing(schedule) {
                        return app.editingSchedule.id === schedule.id;
                    }
                    ,
                    editSchedule() {
                        const schedule = app.editingSchedule;
                        if (!isValidContent(schedule.content)) {
                            return;
                        }
                        if (!isValidDateTime(schedule.startDateTime, schedule.endDateTime)) {
                            return;
                        }

                        const editArea = $('#schedule-' + schedule.id);
                        editArea.waitMe();
                        $.ajax({
                            url: '/api/schedules/' + schedule.id,
                            type: 'PUT',
                            data: JSON.stringify({
                                content: schedule.content,
                                startDateTime: toLocalISOString(new Date(schedule.startDateTime)),
                                endDateTime: toLocalISOString(new Date(schedule.endDateTime)),
                                memberId: memberId,
                                visibility: schedule.visibility,
                            }),
                            contentType: 'application/json',
                            success: (data) => {
                                app.cancelEditMode();
                                app.loadSchedule(app.year, app.month);
                            },
                            error: (data) => {
                                Swal.fire({
                                    icon: 'error',
                                    title: '저장에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }, complete: () => {
                                editArea.waitMe('hide');
                            }
                        })
                    }
                    ,
                    swapSchedule(schedule1, schedule2) {
                        $('#detail-view-modal .schedules').waitMe();
                        if (!schedule1 || !schedule2 || schedule1 == schedule2) {
                            return;
                        }
                        fetch(`/api/schedules/${schedule1.id}/position?id2=${schedule2.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                        }).then((response) => {
                            $('.schedules').waitMe('hide');
                            if (response.ok) {
                                app.loadSchedule(app.year, app.month);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '순서 변경에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }
                        });
                    }
                    ,
                    deleteSchedule(schedule) {
                        Swal.fire({
                            title: '일정을 삭제하시겠습니까?',
                            html: `다음의 일정을 삭제합니다.<br/>[${schedule.content}]<br/> 삭제된 일정은 복구할 수 없습니다.`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#999',
                            confirmButtonText: '삭제',
                            cancelButtonText: '취소',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const deleteArea = $('#schedule-' + schedule.id);
                                deleteArea.waitMe();
                                $.ajax({
                                    url: '/api/schedules/' + schedule.id,
                                    type: 'DELETE',
                                    success: (data) => {
                                        app.loadSchedule(app.year, app.month);
                                    },
                                    error: (data) => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: '삭제에 실패했습니다.',
                                            showConfirmButton: false,
                                            timer: 1500
                                        });
                                    }, complete: () => {
                                        deleteArea.waitMe('hide');
                                    }
                                })
                            }
                        })
                    }
                    ,
                    dutyTypeClasses(type, duty) {
                        const departmentLength = app.department.dutyTypes.length;
                        const colClass = (departmentLength === 2 || departmentLength === 4) ? 'col-md-6' : 'col-md-4';
                        return {
                            ['BACKGROUND-' + type.color]: true,
                            selected: type.id === duty.dutyTypeId,
                            [colClass]: true,
                        };
                    }
                    ,
                    async loadHolidays(year, month) {
                        const response = await fetch(`/api/holidays?year=${year}&month=${month}`);

                        if (!response.ok) {
                            console.log(`Error loading holidays. Status Code: ${response.status}`);
                            return;
                        }

                        this.holidaysByDays = await response.json();
                    }
                    ,
                    loadFriends() {
                        if (!loginMemberId) {
                            return;
                        }
                        fetch('/api/friends')
                            .then(async response => {
                                if (!response.ok) {
                                    console.log(`Error loading friends. Status Code: ${response.status}`);
                                    return;
                                }
                                this.friends = await response.json();
                            });
                    },
                    addTag(scheduleId, friendId) {
                        fetch(`/api/schedules/${scheduleId}/tags/${friendId}`, {
                            method: 'POST',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '태그 추가에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            app.loadSchedule(app.year, app.month);
                        });
                    }
                    ,
                    untag(scheduleId, friendId) {
                        fetch(`/api/schedules/${scheduleId}/tags/${friendId}`, {
                            method: 'DELETE',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '태그 제거에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            app.loadSchedule(app.year, app.month);
                        });
                    }
                    ,
                    untagSelf(schedule) {
                        const scheduleId = schedule.id;
                        const scheduleElement = document.getElementById('schedule-' + scheduleId);
                        const scheduleBy = scheduleElement.querySelector('.schedule-tags').querySelector('.schedule-tag').innerText;

                        Swal.fire({
                            title: '정말로 태그를 제거하시겠습니까?',
                            html: `태그된 아래의 일정을 제거합니다.<br/>[${schedule.content}] by${scheduleBy}<br/> 태그를 다시 복구하려면 해당 사용자에게 요청해야합니다.`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#999',
                            confirmButtonText: '제거',
                            cancelButtonText: '취소',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                fetch(`/api/schedules/${scheduleId}/tags`, {
                                    method: 'DELETE',
                                }).then(response => {
                                    if (!response.ok) {
                                        Swal.fire({
                                            icon: 'error',
                                            title: '태그 제거에 실패했습니다.',
                                            showConfirmButton: false,
                                            timer: 1500
                                        });
                                        return;
                                    }
                                    app.loadSchedule(app.year, app.month);
                                });
                            }
                        });
                    }
                    ,
                    privacyPopup() {
                        $('#privacy-config-modal').modal('show');
                    }
                    ,
                    setPrivacy(event) {
                        document.querySelector('.privacy-config .btn.selected').classList.remove('selected');
                        const privacy = event.target.getAttribute('data-privacy');

                        fetch(`/api/members/${memberId}/visibility`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                visibility: privacy
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '공개 대상 설정 변경에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            app.calendarVisibility = privacy;
                        });
                    },
                    addTodoModal() {
                        const modal = document.getElementById('add-todo-modal');
                        modal.querySelector('.todo-title').value = '';
                        modal.querySelector('.todo-content').value = '';
                        $('#add-todo-modal').modal('show');
                    },
                    addTodo() {
                        const addTodoModal = document.getElementById('add-todo-modal');
                        const title = addTodoModal.querySelector('.todo-title').value;
                        const content = addTodoModal.querySelector('.todo-content').value;

                        fetch('/api/todos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: title,
                                content: content,
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 추가에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 추가되었습니다.',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            app.loadTodos();
                            $('#add-todo-modal').modal('hide');
                        });

                    }, showTodoDetails(todo) {
                        const modal = document.getElementById("todo-details-modal");
                        modal.querySelector(".todo-title").value = todo.title;
                        modal.querySelector(".todo-content").value = todo.content;
                        modal.querySelector(".todo-date").textContent = todo.createdDate;
                        $('#todo-details-modal').modal('show');

                        modal.setAttribute('data-id', todo.id);
                        app.editTodoMode = false;
                    },
                    deleteTodo() {
                        const modal = document.getElementById("todo-details-modal");
                        const todoId = modal.getAttribute('data-id');

                        fetch(`/api/todos/${todoId}`, {
                            method: 'DELETE',
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 삭제에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 삭제되었습니다.',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            app.loadTodos();
                            $('#todo-details-modal').modal('hide');
                        });
                    },
                    initSortable() {
                        let todoListElement = document.getElementById('todo-list');
                        if (todoListElement) {
                            const sortable = new Sortable(todoListElement, {
                                animation: 150,
                                draggable: ".todo-item",
                                handle: '.handle',
                                onEnd: (evt) => {
                                    app.updatePosition();
                                },
                            });
                        }
                    },
                    loadTodos() {
                        fetch('/api/todos')
                            .then(response => {
                                if (!response.ok) {
                                    console.log(`Error loading todos. Status Code: ${response.status}`);
                                    return;
                                }
                                return response.json();
                            }).then(data => {
                            this.todos = data;
                        });
                    },
                    updatePosition() {
                        const todoListElement = document.getElementById('todo-list');
                        const todoItems = todoListElement.querySelectorAll('.todo-item');
                        const todoIds = Array.from(todoItems).map(todo => todo.getAttribute('data-id'));
                        fetch('/api/todos/position', {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(todoIds)
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 순서 변경에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                        });
                    },
                    updateTodo() {
                        const modal = document.getElementById("todo-details-modal");
                        const todoId = modal.getAttribute('data-id');
                        const title = modal.querySelector('.todo-title').value;
                        const content = modal.querySelector('.todo-content').value;
                        fetch(`/api/todos/${todoId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: title,
                                content: content,
                            })
                        }).then(response => {
                            if (!response.ok) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '할 일 수정에 실패했습니다.',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                                return;
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '할 일이 수정되었습니다.',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            app.loadTodos();
                            $('#todo-details-modal').modal('hide');
                        });
                    },
                }
            }
        )
    })

    function sameDateTime(startDateTime, endDateTime) {
        return startDateTime.getTime() === endDateTime.getTime();
    }

    function isValidContent(content) {
        if (!content) {
            Swal.fire({
                icon: 'error',
                title: '내용을 입력해주세요.',
                showConfirmButton: false,
                timer: 1500
            });
            return false;
        }
        return true;
    }

    function isValidDateTime(startDateTime, endDateTime) {
        if (!startDateTime || !endDateTime) {
            Swal.fire({
                icon: 'error',
                title: '시작일시와 종료일시를 모두 입력해주세요.',
                confirmButtonText: '확인',
            });
            return false;
        }
        if (new Date(startDateTime) > new Date(endDateTime)) {
            Swal.fire({
                icon: 'error',
                title: '종료일시는 시작일시보다 빠를 수 없습니다.',
                confirmButtonText: '확인',
            });
            return false;
        }
        return true;
    }

</script>
