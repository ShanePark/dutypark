<div id="detail-view-modal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content card" v-if="detailView">
      <div class="card-header modal-header text-center py-3 px-4">
        <p class="current-date-label fs-3 mb-0"
           v-text="detailView?.year + '년 ' + detailView?.month + '월 ' + detailView?.day + '일'"></p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-1">
        <div v-if="!isCreateScheduleMode" class="dutyTypes px-4 py-2">
          <form>
            <div v-for="type in team.dutyTypes" class="pretty p-round p-pulse">
              <input type="radio" name="dutyType"
                     :checked="isDutyType(detailView.duty, type)"
                     v-on:click="changeDutyTypeWithPopup(detailView.duty, type)"
              />
              <div class="state p-primary">
                <label v-text="type.name"></label>
              </div>
            </div>
          </form>
        </div>
        <div class="schedules">
          <div v-if="!isCreateScheduleMode && schedulesByDays[detailView.index]?.length === 0"
               class="text-align-center m-5 p-5">
            <p class="text-center text-muted fs-3">등록된 일정이 없습니다</p>
          </div>
          <div class="schedule card shadow"
               v-if="!isCreateScheduleMode"
               :class="['visibility-' + schedule.visibility]"
               v-for="(schedule, s_index) in schedulesByDays[detailView.index]"
               :id="'schedule-' + schedule.id">
            <div class="schedule-body">
              <p class="schedule-content">
                <i v-if="schedule.visibility === 'PRIVATE'" class="bi bi-lock-fill"></i>
                {{ schedule.content }}
                <template v-if="schedule.totalDays > 1">
                  [{{ schedule.daysFromStart }}/{{ schedule.totalDays }}]
                </template>
              </p>
              <div v-if="schedule.description" class="schedule-description">
                <hr/>
                <div v-html="replaceLineBreaks(schedule.description)"></div>
              </div>

              <!-- Attachment Gallery (Read-only) -->
              <div v-if="schedule.attachments && schedule.attachments.length > 0" class="schedule-attachments mt-3">
                <hr/>
                <div class="fw-bold mb-2">
                  <i class="bi bi-paperclip"></i> 첨부파일 ({{ schedule.attachments.length }})
                </div>
                <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-2">
                  <div v-for="attachment in schedule.attachments" :key="attachment.id" class="col">
                    <div class="card h-100 position-relative">
                      <a :href="attachment.downloadUrl || ('/api/attachments/' + attachment.id + '/download')"
                         class="attachment-download position-absolute btn btn-sm"
                         download
                         title="다운로드">
                        <i class="bi bi-download text-white"></i>
                      </a>
                      <div class="position-relative overflow-hidden" style="padding-top: 100%;">
                        <div v-if="attachment.hasThumbnail"
                             class="position-absolute top-0 start-0 w-100 h-100 attachment-thumbnail-clickable"
                             style="cursor: pointer;"
                             @click="openAttachmentViewer(attachment)">
                          <img :src="attachment.thumbnailUrl"
                               :alt="attachment.originalFilename"
                               class="w-100 h-100"
                               style="object-fit: cover;">
                          <div
                              class="attachment-hover-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-search text-white" style="font-size: 2rem;"></i>
                          </div>
                        </div>
                        <div v-else
                             class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                          <i :class="['bi', attachmentIconClass(attachment), 'text-muted', 'display-4', 'lh-1']"></i>
                        </div>
                      </div>
                      <div class="card-body p-2">
                        <div class="small text-truncate" :title="attachment.originalFilename">
                          {{ attachment.originalFilename }}
                        </div>
                        <div class="small text-muted">{{ formatBytes(attachment.size) }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="schedule-tags fs-4">
                <span
                    v-for="tag in schedule.tags"
                    v-if="tag.id !== memberId"
                    :key="tag.id"
                    class="schedule-tag"
                    @click="untag(schedule, tag.id)"
                >{{ tag.name }}</span><span
                  v-if="schedule.isTagged"
                  class="schedule-tag tagged-true"
              >{{ schedule.owner }}</span>
                <div
                    v-if="!schedule.isTagged && friends.length > 0"
                    class="schedule-tag schedule-tag-add"
                >
                  <div class="btn-group dropstart">
                    <span class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-person-plus-fill"></i> 태그
                    </span>
                    <ul class="dropdown-menu">
                      <li v-for="friend in friends"
                          v-if="!schedule.tags.find(tag => tag.id === friend.id)"
                          @click="addTag(schedule.id, friend.id)">
                        <a class="dropdown-item" href="javascript:void(0)">[{{ friend.team }}] {{ friend.name }}</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <div class="buttons mt-3">
              <template v-if="schedule.isTagged && isMyCalendar">
                <button class="btn btn-danger" v-on:click="untagSelf(schedule)">태그제거</button>
              </template>
              <template v-else>
                <template
                    v-if="schedulesByDays[detailView.index].length > detailView.scheduleStartDiffCount + 1 && dutyAndDateTimeSame(detailView, schedule.startDateTime)">
                  <button
                      :disabled="s_index == schedulesByDays[detailView.index].length -1 || schedulesByDays[detailView.index][s_index+1].isTagged"
                      v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index+1])"
                      class="btn btn-secondary"
                  >
                    <i class="bi bi-arrow-down-square"></i>
                  </button>
                  <button :disabled="s_index <= detailView.scheduleStartDiffCount"
                          v-on:click="swapSchedule(schedule, schedulesByDays[detailView.index][s_index-1])"
                          class="btn btn-secondary">
                    <i class="bi bi-arrow-up-square"></i>
                  </button>
                </template>
                <button class="btn btn-info" v-on:click="scheduleEditMode(schedule)">수정</button>
                <button class="btn btn-danger" v-on:click="deleteSchedule(schedule)">삭제</button>
              </template>
            </div>
          </div>
          <div id="schedule-create-or-edit" class="schedule card shadow" v-if="isCreateScheduleMode">
            <div class="schedule-edit">
              <label>일정 제목<span class="content-length ms-2"
                                v-text="createSchedule.content.length + ' / ' + schedule_content_max_length"></span>
                <small class="help-note">달력에 표시되는 제목이에요 <i class="bi bi-info-circle-fill"></i></small>
                <input class="form-control border-dark" placeholder="일정 제목을 입력하세요."
                       :maxlength="schedule_content_max_length"
                       v-model="createSchedule.content"/>
              </label>
              <label>일정 상세<small class="help-note">달력에 표시되지 않고 클릭했을때만 보여져요 <i
                  class="bi bi-info-circle-fill"></i></small>
                <textarea class="form-control" placeholder="일정 상세정보를 입력하세요.(선택 사항)" rows="3"
                          v-model="createSchedule.description"></textarea>
              </label>
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="schedule-field-row d-flex flex-wrap align-items-center gap-2">
                    <label class="schedule-field-label mb-0 text-nowrap">시작일</label>
                    <div class="schedule-field-control flex-grow-1">
                      <input v-show="createSchedule.id" type="date" class="form-control"
                             v-model="createSchedule.startDate"/>
                      <p v-show="!createSchedule.id" class="form-control bg-light mb-0"
                         v-text="createSchedule.startDate"></p>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="schedule-field-row d-flex flex-wrap align-items-center gap-2">
                    <label class="schedule-field-label mb-0 text-nowrap">시작시간</label>
                    <div class="schedule-field-control flex-grow-1">
                      <input type="time" class="form-control" v-model="createSchedule.startTime"/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="schedule-field-row d-flex flex-wrap align-items-center gap-2">
                <label class="schedule-field-label mb-0 text-nowrap">종료일시</label>
                <div class="schedule-field-control flex-grow-1">
                  <input type="datetime-local" class="form-control" v-model="createSchedule.endDateTime"
                         :min="createSchedule.startDateTime"/>
                </div>
              </div>
              <div class="schedule-field-row d-flex flex-wrap align-items-center gap-2">
                <label class="schedule-field-label mb-0 text-nowrap">공개설정</label>
                <div class="schedule-field-control schedule-visibility d-flex flex-wrap gap-2">
                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PUBLIC" v-model="createSchedule.visibility"/>
                    <div class="state p-success-o">
                      <label>전체</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FRIENDS" v-model="createSchedule.visibility"/>
                    <div class="state p-info-o">
                      <label>친구</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="FAMILY" v-model="createSchedule.visibility"/>
                    <div class="state p-warning-o">
                      <label>가족</label>
                    </div>
                  </div>

                  <div class="pretty p-default p-curve">
                    <input type="radio" value="PRIVATE" v-model="createSchedule.visibility"/>
                    <div class="state p-danger-o">
                      <label>비공개</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="schedule-field-row d-flex flex-wrap align-items-start gap-3 mt-3">
                <label class="schedule-field-label mb-0 text-nowrap pt-2">첨부파일</label>
                <div class="schedule-field-control attachment-gallery">
                  <div class="attachment-tile" v-for="attachment in createSchedule.uploadedAttachments"
                       :key="attachment.id">
                    <div class="attachment-thumb">
                      <img v-if="attachment.isImage && attachment.thumbnailUrl"
                           :src="attachment.thumbnailUrl"
                           :alt="attachment.name"
                           class="w-100 h-100" style="object-fit: cover;">
                      <img v-else-if="attachment.isImage"
                           :src="attachment.previewUrl"
                           :alt="attachment.name"
                           class="w-100 h-100" style="object-fit: cover;">
                      <div v-else class="d-flex align-items-center justify-content-center h-100">
                        <i :class="['bi', attachmentIconClass(attachment), 'text-muted', 'display-4', 'lh-1']"></i>
                      </div>
                    </div>
                    <div class="attachment-meta">
                      <div class="attachment-name" :title="attachment.name">{{ attachment.name }}</div>
                      <div class="attachment-size">{{ formatBytes(attachment.size) }}</div>
                      <div class="attachment-progress"
                           v-if="createSchedule.attachmentProgress[attachment.id] !== undefined && createSchedule.attachmentProgress[attachment.id] < 100">
                        <div class="progress" style="height: 4px;">
                          <div class="progress-bar"
                               :style="{width: createSchedule.attachmentProgress[attachment.id] + '%'}"></div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="attachment-remove btn btn-sm btn-danger"
                            @click="removeAttachment(attachment.id)">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>

                  <!-- File picker button -->
                  <div class="attachment-tile attachment-add-button">
                    <input type="file" id="schedule-attachment-input" multiple style="display: none;"/>
                    <label for="schedule-attachment-input"
                           class="attachment-thumb d-flex flex-column align-items-center justify-content-center h-100 m-0"
                           style="cursor: pointer;">
                      <i class="bi bi-plus-circle text-muted" style="font-size: 3rem;"></i>
                      <small class="text-muted mt-2" style="font-size: 0.75rem;">드래그 또는 클릭</small>
                    </label>
                  </div>
                </div>
              </div>

              <div v-if="attachmentUploadSummary" class="alert alert-info d-flex align-items-center gap-3 mb-0">
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">업로드 중</span>
                  </div>
                  <span class="fw-semibold">파일 업로드 중</span>
                </div>
                <div class="flex-grow-1 small text-muted">
                  <span>{{ attachmentUploadSummary.activeUploads }}개 파일</span>
                  <span class="mx-1">|</span>
                  <span>{{ formatBytes(attachmentUploadSummary.uploadedBytes) }} / {{ formatBytes(attachmentUploadSummary.totalBytes) }}</span>
                  <span class="mx-1">|</span>
                  <span>{{ attachmentUploadSummary.progressPercent }}%</span>
                  <span class="mx-1">|</span>
                  <span v-if="attachmentUploadSummary.speedBytesPerSec > 0">{{ formatBytes(attachmentUploadSummary.speedBytesPerSec) }}/s</span>
                  <span v-else>속도 계산 중</span>
                  <span class="mx-1">|</span>
                  <span v-if="attachmentUploadSummary.remainingSeconds !== null">남음 {{ formatDuration(attachmentUploadSummary.remainingSeconds) }}</span>
                  <span v-else>남은 시간 계산 중</span>
                  <span class="mx-1">|</span>
                  <span>경과 {{ formatDuration(attachmentUploadSummary.elapsedSeconds) }}</span>
                </div>
              </div>
              <div class="buttons">
                <button
                    id="add-btn"
                    class="btn btn-success"
                    :disabled="isAttachmentUploading"
                    :title="isAttachmentUploading ? '파일 업로드가 완료되면 저장할 수 있습니다.' : null"
                    v-on:click="saveSchedule">
                  <span v-if="isAttachmentUploading" class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">업로드 중</span>
                  </span>
                  <span>저장</span>
                </button>
                <button class="btn btn-secondary" v-on:click="cancelCreateSchedule">취소</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="schedule-add-button card shadow w-100" v-if="!isCreateScheduleMode">
          <button class="btn btn-success py-4" v-on:click="scheduleCreateMode()">일정 추가</button>
        </div>
      </div>
    </div>
  </div>
</div>
