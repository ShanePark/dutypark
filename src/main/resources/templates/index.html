<div id="app" class="container mt-4 dashboard">
  <!-- My 섹션 -->
  <div class="mb-4">
    <div class="bg-white rounded shadow-sm border">
      <div class="bg-primary text-center py-2 rounded-top fw-bold text-uppercase text-white cursor-pointer"
           @click="moveTo()">내 시간표
      </div>
      <div class="p-4">
        <h5 class="d-flex align-items-center mb-3">
          <i class="bi bi-calendar-check me-2"></i>
          {{ today }}
        </h5>
        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>근무</h5>
          <div class="duty-type ms-lg-2">
            <div :class="['BACKGROUND-' + myDuty.dutyColor]">
              <span v-text="myDuty.dutyType"></span>
            </div>
          </div>
        </div>
        <h5 class="mb-1 fw-semibold"><i class="bi bi-calendar-event me-2"></i>일정</h5>
        <ul class="list-unstyled">
          <li v-for="schedule in mySchedules" :key="schedule.id" class="py-1 border-bottom last:border-0">
            <span class="fw-bold">{{ schedule.content }}</span>
            <span class="text-secondary ms-2">{{ printScheduleTime(schedule.startDateTime) }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Team 섹션 -->
  <div class="mb-4 team-section">
    <div class="bg-white rounded shadow-sm border">
      <div class="bg-success text-center py-2 rounded-top fw-bold text-uppercase text-white"
           v-text="myDepartment.name"></div>
      <div class="p-4">
        <div v-for="group in groupedTeamMembers" class="mb-4">
          <div class="duty-type ms-lg-2">
            <div :class="['BACKGROUND-' + group.dutyType.color]">
              <span v-text="group.dutyType.name"></span>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span v-for="member in group.members" :key="member.id">
              <a href="#" @click.prevent="moveTo(member.id)" class="text-decoration-none">
                <i class="bi bi-person-fill"></i> {{ member.name }}
              </a>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Friends 섹션 -->
  <div class="mb-4">
    <div class="bg-white rounded shadow-sm border">
      <div class="bg-warning text-center py-2 rounded-top fw-bold text-uppercase text-dark">Friends</div>
      <div class="p-4">
        <div v-for="friend in friends" :key="friend.id" class="p-4 border rounded mb-4 cursor-pointer hover-bg-light"
             @click="goToFriendSchedule(friend)">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fs-5 fw-bold">{{ friend.name }}</div>
            <button class="btn btn-outline-secondary btn-sm" @click.stop="toggleManage(friend)">
              <i class="bi bi-gear"></i>
            </button>
          </div>
          <p class="mt-2 text-muted">
            <i class="bi bi-person-badge me-1"></i> 근무: {{ friend.todayDuty }}
          </p>
          <div class="mt-2">
            <template v-if="friend.schedules && friend.schedules.length">
              <ul class="list-unstyled">
                <li v-for="schedule in friend.schedules" :key="schedule.id"
                    class="text-sm py-1 border-bottom last:border-0">
                  <span class="fw-semibold">{{ schedule.content }}</span>
                  <span class="text-secondary ms-2">{{ schedule.startDateTime }} - {{ schedule.endDateTime }}</span>
                </li>
              </ul>
            </template>
            <template v-else>
              <p class="text-muted">일정이 없습니다.</p>
            </template>
          </div>
          <div v-if="friend.showManage" class="mt-2 text-end">
            <button class="btn btn-danger btn-sm" @click.stop="deleteFriend(friend)">
              <i class="bi bi-trash me-1"></i> 친구삭제
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    const app = new Vue({
        el: "#app",
        data: {
            today: new Date().toLocaleDateString("ko-KR", {
                year: "numeric", month: "long", day: "numeric", weekday: "long"
            }),
            myInfo: {},
            myDuty: {},
            mySchedules: [],
            myDepartment: {},
            groupedTeamMembers: [],
            friends: [
                {
                    id: 1,
                    name: "친구1",
                    todayDuty: "데이",
                    schedules: [
                        {id: 'fs1', content: '일정1', startDateTime: '10:00', endDateTime: '11:00'},
                        {id: 'fs2', content: '일정2', startDateTime: '11:30', endDateTime: '12:30'},
                        {id: 'fs3', content: '일정3', startDateTime: '14:00', endDateTime: '15:00'}
                    ],
                    showManage: false
                },
                {
                    id: 2,
                    name: "친구2",
                    todayDuty: "이브닝",
                    schedules: [],
                    showManage: false
                },
                {
                    id: 3,
                    name: "친구3",
                    todayDuty: "나이트",
                    schedules: [
                        {id: 'fs4', content: '일정1', startDateTime: '18:00', endDateTime: '19:00'}
                    ],
                    showManage: false
                },
                {
                    id: 4,
                    name: "친구4",
                    todayDuty: "OFF",
                    schedules: [
                        {id: 'fs5', content: '일정1', startDateTime: '09:00', endDateTime: '10:00'},
                        {id: 'fs6', content: '일정2', startDateTime: '10:30', endDateTime: '11:30'}
                    ],
                    showManage: false
                }
            ]
        },
        mounted() {
            this.loadMy();
            this.loadTeamMembers();
        },
        computed: {},
        methods: {
            loadMy() {
                fetch("/api/dashboard/my")
                    .then(res => res.json())
                    .then(data => {
                        this.myInfo = data.member;
                        this.myDuty = data.duty;
                        this.mySchedules = data.schedules;
                    });
            },
            loadTeamMembers() {
                fetch("/api/dashboard/department")
                    .then(res => res.json())
                    .then(data => {
                        app.groupedTeamMembers = data.dutyTypes
                        app.myDepartment = data.department;
                    });
            },
            moveTo(id) {
                if (!id)
                    id = app.myInfo.id;
                location.href = "/duty/" + id;
            },
            printScheduleTime(startDateTime) {
                let date = new Date(startDateTime);
                if (date.toLocaleDateString() !== new Date().toLocaleDateString()) {
                    return "";
                }

                if (date.getHours() === 0 && date.getMinutes() === 0) {
                    return "";
                }

                return date.toLocaleTimeString("ko-KR", {
                    hour: "2-digit", minute: "2-digit"
                });
            },
            goToFriendSchedule(friend) {
                // 친구의 스케줄 페이지로 이동 (예시)
                alert(friend.name + "의 시간표 페이지로 이동합니다.");
            },
            toggleManage(friend) {
                friend.showManage = !friend.showManage;
            },
            deleteFriend(friend) {
                if (confirm(friend.name + "을(를) 친구 목록에서 삭제하시겠습니까?")) {
                    this.friends = this.friends.filter(f => f.id !== friend.id);
                }
            }
        }
    });
</script>
