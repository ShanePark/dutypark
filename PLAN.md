# TODO 첨부파일 재구현 PLAN

## 현재 상황 요약
- 현재 브랜치에는 TODO에도 첨부 기능을 붙이려다 실패한 변경(백엔드 5개, 프런트 7개, 테스트 2개 파일)이 널리 퍼져 있으며, `AttachmentService`·`TodoService`·Vue 모듈 전반에 임시 코드가 들어간 상태다.
- 스케줄 첨부 기능은 세션 생성 → 업로드 → 정렬/삭제 → 세션 확정이라는 일관된 플로우를 가지고 있으나 TODO 쪽 로직은 이 플로우를 그대로 따르지 못해 세션 정리/권한 검증/프런트 바인딩이 모두 깨져 있다.
- 따라서 마지막 커밋 기준으로 작업 트리를 완전히 되돌린 뒤, 스케줄 첨부 동작을 공통화하면서 TODO 전용 커버리지를 TDD 순서(RED→GREEN→REFACTOR→FRONT)대로 쌓아가야 한다.

## 단계별 체크리스트

### 0. 베이스라인 초기화
- [x] 현재 작업 트리를 마지막 커밋 상태로 완전히 되돌리고 `git status`가 깨끗함을 확인한다.
- [x] 복원 상태에서 `./gradlew test` 혹은 최소 핵심 단위 테스트를 돌려 기본 라인이 깨지지 않았음을 확인한다.

### 1. RED: 테스트 코드 선작성
- [x] 스케줄 첨부 플로우를 기준으로 TODO 첨부 요구사항(세션 확정, 정렬, 삭제, 권한)을 정리하고 테스트 시나리오를 문서화한다.
- [x] `TodoServiceTest`(혹은 전용 `TodoAttachmentServiceTest`)에 다음 RED 시나리오를 추가한다: (1) 첨부 세션이 있는 신규 TODO 생성, (2) 첨부 세션 없이 기존 첨부만 정렬, (3) TODO 삭제 시 첨부도 함께 정리, (4) 타인 TODO 접근 시 예외.
- [x] `AttachmentPermissionEvaluatorTest`에 TODO 컨텍스트 접근 제약(세션 소유권, 읽기/쓰기 권한, 잘못된 contextId) 케이스를 보강한다.
- [x] `TodoControllerTest` 혹은 통합 테스트에서 첨부 관련 API 계약을 RED 상태로 명시한다.

### 2. GREEN: 백엔드 구현
- [ ] 스케줄과 TODO가 공유할 첨부 세션 처리/정렬/정리 로직을 `AttachmentService`/`AttachmentUploadSessionService`에 공통화하고, TODO 컨텍스트에서 사용할 헬퍼(예: `TodoAttachmentManager`)를 신설한다.
- [ ] `TodoService`와 `TodoController` DTO(`TodoRequest`, `TodoResponse`)를 정리하여 첨부 세션 ID·정렬 ID·첨부 응답 DTO가 일관되게 오가도록 구현한다.
- [ ] `AttachmentPermissionEvaluator`와 관련 리포지토리 계층에서 TODO 권한 검증을 확실히 하고, 세션 생성/확정/삭제 API가 TODO 컨텍스트에서도 동작하도록 한다.
- [ ] API 스펙 변화 시 REST Docs/검증 로직을 업데이트하고, 새로 추가된 테스트가 GREEN이 되도록 최소 구현을 맞춘다.

### 3. 리팩터링
- [ ] 스케줄/TODO 공통 첨부 로직에서 중복된 파일 이동·삭제·정렬 코드를 메서드 추출 또는 전략 패턴으로 정리한다.
- [ ] 서비스/컨트롤러 레이어에서 부수 효과(로그, 예외 메시지 등)를 일관화하고, DTO/엔티티 변환을 전담하는 매퍼/팩토리를 도입해 책임을 분리한다.
- [ ] 테스트 중복을 줄이기 위해 공통 픽스처/헬퍼를 도입하고, 의미가 겹치는 검증은 파라미터라이즈드 테스트로 단순화한다.

### 4. 프런트엔드 구현
- [ ] 첨부 업로더 세션 생성/정리/진행률 표시를 스케줄·TODO에서 함께 사용할 헬퍼 모듈로 분리하고, 기존 스케줄 업로더와 호환되도록 API 래퍼를 작성한다.
- [ ] TODO 추가/수정 모달(`todo-add-modal`, `todo-detail-modal`)과 `duty.js` 상태 트리에 첨부 목록/프리뷰/삭제/정렬 UI를 설계하고, Vue 메서드를 통해 API와 동기화한다.
- [ ] 일정 상세 모달, Todo 목록 뷰, Attachment 갤러리 등에서 썸네일·다운로드 링크·삭제 버튼 상태가 실제 권한/상태와 맞도록 바인딩을 점검한다.
- [ ] 프런트 변경 후 DevTools(혹은 간단한 브라우저 테스트)로 업로드→확정→삭제→재정렬 플로우가 끊기지 않는지 수동 검증한다.

### 5. 검증 & 마무리
- [ ] 전체 `./gradlew test` 및 필요한 경우 `./gradlew asciidoctor`를 실행해 회귀를 방지한다.
- [ ] 브라우저에서 TODO 첨부 CRUD 플로우를 최소 2회(신규 생성/기존 편집) 검증하고, 콘솔/네트워크 에러가 없는지 확인한다.
- [ ] 문서화가 필요하면 `README`나 별도 위키에 TODO 첨부 사용법을 추가하고, 사용자 테스트 피드백 목록을 남긴다.
